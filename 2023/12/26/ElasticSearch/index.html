<!DOCTYPE html><html lang="ch" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>ElasticSearch | 后端开发</title><meta name="keywords" content="中间件,搜索引擎"><meta name="author" content="XIAO YANG"><meta name="copyright" content="XIAO YANG"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="ElasticSearch"><meta name="application-name" content="ElasticSearch"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta name="referrer" content="no-referrer"><meta property="og:type" content="article"><meta property="og:title" content="ElasticSearch"><meta property="og:url" content="https://yangxiao23.github.io/yangxiao.github.io/2023/12/26/ElasticSearch/index.html"><meta property="og:site_name" content="后端开发"><meta property="og:description" content="搜索与分析实战"><meta property="og:locale" content="ch"><meta property="og:image" content="https://yangxiao23.github.io/yangxiao.github.io/img/headimg.jpg"><meta property="article:author" content="XIAO YANG"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://yangxiao23.github.io/yangxiao.github.io/img/headimg.jpg"><meta name="description" content="搜索与分析实战"><link rel="shortcut icon" href="/yangxiao.github.io/favicon.ico"><link rel="canonical" href="https://yangxiao23.github.io/yangxiao.github.io/2023/12/26/ElasticSearch/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/yangxiao.github.io/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/yangxiao.github.io/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: XIAO YANG","link":"链接: ","source":"来源: 后端开发","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '后端开发',
  title: 'ElasticSearch',
  postAI: '',
  pageFillDescription: '配置, 深入原理, ElasticSearch集群形成机制, 索引分片的分配机制, 分片分配的感知, 索引分片的恢复机制, 索引数据的写入过程, 索引数据的搜索过程, 索引数据, 定义索引结构, 字段复制和字段存储, 动态映射, 使用乐观锁进行并发控制, 索引数据的批量写入, 索引重建, 索引数据的路由规则, 索引别名, 别名配合数据过滤, 别名配合数据路由, 滚动索引, 索引的状态管理, 清空缓存, 刷新索引, 冲洗索引, 强制合并, 关闭索引, 冻结索引, 索引的块, 索引模板, 使用模板组件简化模板配置, 索引的监控, 监控索引的健康状态, 监控索引分片的段数据, 监控索引分片的分配, 监控索引分配的恢复, 监控索引的统计指标, 控制索引分片的分配, 文本分析, 文本分析的原理, 标准分析器, 简单分析器, 空格分析器, IK分析器分析文本, 自定义文本分析器分析文本, 字符过滤器, 分词器, 分词过滤器, 查看文档得到词条向量, keyword类型字段的标准化, 搜索数据, 全文检索, 匹配搜索, 布尔前缀匹配搜索, 短语搜索, 段语前缀匹配搜索, 多字段匹配搜索, 查询字符串搜索, 经纬度搜索, 圆形搜索, 矩形搜索, 多边形搜索, 复合搜索, 布尔查询, 常量得分查询, 析取最大查询, 相关度增强查询, 搜索结果的总数, 搜索结果分页, 普通分页, 滚动分页, search after分页, 搜索结果的排序, 筛选搜索结果返回的字段, 设置高亮字段, 搜索结果折叠, 解释搜索结果, 聚集统计, 度量聚集, 平均值聚集, 最大值和最小值聚集, 求和聚集, 统计聚集, 基数聚集, 百分比聚集, 百分比等级聚集, 头部名中聚集, 矩证统计聚集, 桶聚集, 词条聚集, 范围聚集, 日期范围聚集, 直方图聚集配置用于配置节点的参数用来配置运行时占用的堆内存大小用来配置运行时的日志参数可以通过调用接口在节点运行时动态修改的配置叫做动态配置配置在文件中只能在集群重启之后才能生效的配置叫做静态配置修改集群配置的方法调用集群节点配置的接口并设置配置项临时生效该配置项在集群重启后失效调用集群节点配置的接口并设置配置项持久有效该配置项在集群重启后依然有效直接把集群节点配置项写在文件中优先级递减持久生效临时设置查询配置结果和用来配置数据目录和日志目录可以配置多个目录操作系统内存锁的配置项开启内存锁可以防止操作系统中的缓存数据被交换到外存而导致查询性能大幅下降可以进行查询和用于把的服务绑定到固定的地址和端口号和搭建集群时这两个配置项对于节点的发现和主节点的选举至关重要用于配置一组地址或主机名代表集群中主候选节点的列表当一个节点启动时会尝试把该列表中各个主候选节点建立连接如果连接成功并找到主节点就把该节点加入集群用于明确的指定一组节点名称的列表这个列表也是主候选节点的列表集群在第一次启动时会读取该列表初始化投票配置该配置将用于主节点的选举配置的堆内存需要根据服务器的硬件配置修改运行时的堆内存以保证集群节点拥有足够的堆内存内存设置过少可能查询时内存不够而导致服务宕机如果设置过大又会超过用于压缩对象指针的阈值而导致内存浪费在配置堆内存大小的时候需要满足以下两个条件堆内存最大不得超过开启压缩对象指针的阈值在堆内存不超过压缩对象指针的阈值的前提下其大小可以设置为所在节点的一半特性分布式大数据搜索和分析引擎很容易拓展在海量数据场景下仍然可以保持很高的查询性能不支持事务管理深入原理搜索引擎通常包括数据采集模块文本分析模块索引存储模块搜索模块等数据采集模块中支持官方工具第三方工具客户端写入的数据文本分析模块可以将结构化数据中长文本切割分为有实际意义的词用于可以使用切分出来的词作为查询条件搜索到该文本索引存储模块负责将数据采集模块写入的数据按照定义好的结构写入索引搜索引擎的索引的数据按照倒排索引的结构进行组织索引存储模块还管理着数据的存储方式路由方式事务日志索引状态等搜索模块根据用户输出的查询文本找到索引中匹配的文档相关度越高的文档排名越靠前集群形成机制重要概念主节点每个集群有且只有一个主节点主节点是整个集群的管理者它负责维护整个集群的元数据并在节点数目发生变化时及时更新集群状态然后将状态分发给集群的其他节点主节点还负责索引分片的分配主候选节点集群中有权参与主节点选举的那些节点选举时超过一半的主候选节点达成一致方能成功选举出来的主节点必须是主候选节点列表中的一个为了维护集群的正常运转任何时候必须确保有一半以上的主候选节点在正常工作算法投票配置包含主节点选举或集群状态需要修改时可参与投票的节点列表在一般情况下投票配置的列表与主候选节点的列表是一致的选举主节点时只有某个节点的得票数超过投票配置中节点数的一半选举才能成功你可以人工排除一些主候选节点即不让它们参与投票集群节点的发现选举和引导过程集群节点引导的主要步骤初始化投票配置确定集群中的主候选节点的列表将配置的节点列表确认为主候选列表写入投票配置选举主节点投票配置中的主候选节点发起主节点的选举只要超过一半的主候选节点达成一致则主节点选举成功发现集群中其他节点每个节点根据配置的主候选节点列表的逐一尝试连接如果联系到主节点就申请加入集群主节点确认连接成功就把该节点加入集群并修改集群的状态然后将集群的最新状态发布到其他节点中保存当所有节点都发现完毕整个集群的状态生成结束时待集群启动完毕就可以对外提供统一服务节点的发现过程是递归的即使某个节点的不包含集群的主节点只要它可以通过列表中的节点间接找到主节点就能被主节点纳入集群集群状态的发布过程对于现有的集群添加和删除节点会改变集群的状态集群的状态是一种庞大的数据结构它包含整个集群的元数据信息当集群状态发生变化时主节点需要把最新的状态发布给每个节点这个过程需要经历以下两个阶段预提交阶段主节点把最新的集群状态数据发布到每个节点每个节点接收状态数据并将其保存在本地然后向主节点发送确认响应正式提交阶段主节点统计收到主候选节点的确认响应数量如果超过一半的主候选节点的确认响应成功则开始正式提交主节点发布提交消息到集群的每个节点通知它们应用最新的集群状态每个节点应用最新的集群状态后向主节点发送最终的确认响应一旦所有的确认响应成功则本次状态发布完成集群状态的发布具有时间限制如果超过时间限制主节点状态没有发布成功则主节点失败主候选节点需要重新选举新的主节点如果某个节点的最终确认响应超过一定时间限制没有发送到主节点则主节点认为该节点掉线将其从集群列表删除主节点和非主节点每隔一段时间就会互相发送心跳检测包如果某个非主节点连续多次心跳检测失败则该节点掉线主节点会把它从集群的状态的删除如果主节点掉线则需要使用投票配置重新选举出新的主节点来管理整个集群索引分片的分配机制目的使用分片分配的感知和分片分配的过滤来人工干预这个过程减少数据丢失的可能性一个索引可以有多个分片分片的分配集群的主节点将索引的各个分片分配到集群的各个节点上的过程当集群的节点数目索引的副本分片发送变化都会触发分片的分配在这个过程中需要把节点现有的分片移动到其他的节点上如果在同一时刻需要移动的分片数太多且分片容量较大则这个过程会比较耗时主节点分配索引分配时默认会尽可能把同一个索引的分片分配到更多的节点上这样在读写索引数据的时候就可以利用更多硬件资源提升读写效率在分配分片的过程中永远不可以把同一个索引的某个主分片和它的副本分片分配到同一个节点上也不可以把某个主分片的多个副本分片分配到同一个节点上获取索引分片分配方案对于一个总分片数为的索引而言当集群节点的数目达到之后继续添加新节点无法再提升该索引的读写性能查看索引分配原因分片分配的感知可以使用分片分配的感知对副本分配的分配位置进行干预分片分配的感知允许把的节点划分为属于不同的区域当分配一个副本分片时不允许将他分配到它主分片所在的区域好处是即使某个区域的节点全部挂掉其他区域依然有相应的副本分片不影响集群的使用想从集群中删除一个节点再关闭该节点前你想把它拥有的分片全部迁移到其他节点上这时候就可以使用分片分配的过滤来完成分片分配的过滤允许配置分片只能或不能分配到某些节点这个配置对整个集群有效配置分片分配过滤需要给每个节点定义一些属性或者使用节点自带的属性以便在设置过滤条件的时候区分它们可以在添加然后调用接口根据分区进行集群分片分片干扰为集群配置过滤节点过滤需要包含的节点需要包含的节点索引分片的恢复机制使用分片的恢复实现在集群节点数发生变化时也能保证索引分片的容错性和完整性索引分片的恢复指的是在某些条件下由于索引的分片缺失把某个索引的分片数据复制一份来得到该分片副本的过程分片的分配当集群节点数增加需要把一个主分片副本分配到新节点上或集群节点数减少或某个节点配置了分配的过滤就会进行分片的分配增加索引的副本数在节点充足的情况下增加索引的副本必然会导致在某些节点上新增新的副本分片从索引备份的快照恢复数据使用索引备份的快照进行数据恢复时也会使用分片的恢复分片恢复分为三种不同类型如果分片是从本地分片复制过来本地存储恢复如果分片是从集群中的其他节点复制过来对等恢复如果分片是从索引备份的快照文件恢复的快照恢复查看分片的恢复情况避免不必要的分片恢复生产环境节点多索引多分片多而且一个分片的容量可能非常大如果某个节点临时断网或者重启集群时未及时启动所有节点导致某些节点下线又上线带来的是新增许多不必要的分片恢复延迟分片的恢复提供一个索引级别的动态配置可以控制节点下线后开始分片恢复主分片的恢复不受影响影响的是副本分片的恢复改变网关中触发分片恢复的条件在中进行配置上述配置的意思是集群启动时先等待个数据节点才开始分片的恢复如果过了还没达到个数据节点只要数据节点达到三个就触发分片的恢复设置为集群数据节点的总数可以有效减少集群重启不必要的分片恢复索引数据的写入过程集群架构索引一条数据的步骤接收到一个文档写入请求根据索引数据的路由规则计算当前文档应当写入哪一主分片假如此时决定路由到则使用传输模块把当前的写入请求转发到进行写入主分片写入完成后把请求转发到上将数据写入副本分片使得和它的副本分片数据保持一致如果主分片写入失败直接返回向客户端报告写入结果支持在一个请求写入多个文档写入步骤接到一个批量写入文档的请求对写入的文档按照路由规则进行分组并把请求转发到每个主分片所在的节点上在每个主分片上写入对应的文档每个文档写入时先写入主分片再写入副本分片直到所有组的问答那个全部写入完毕汇总每个节点各个文档写入的结果并进行返回向索引写入数据时总是先写入主分片在写入副本分片批量写入能减少请求次数推荐使用批量插入索引数据的搜索过程搜索请求即可以使用主分片也可以使用副本分片当请求选择分片时会采取轮询的方式进行分片的选择如果搜索数据时不带路由值则需要选择包含整个索引数据的分片不带路由值的搜索过程接到一个搜索请求该请求不包含路由值接到请求的节点成为协调节点选择搜索要用的分片再选择的每个分片上进行搜索默认情况下每个分片最多会搜索出匹配前条记录作为局部结果局部结果会交给协调节点协调节点会汇总局部结果按照搜索请求的参数进行排序默认返回全局结果的前条数据带路由值的搜索过程接到一个搜索请求该请求包含路由值该节点成为协调节点根据请求的路由值计算搜索的分片轮询方式选择再分片上按照搜索条件完成搜索去除搜索结果的列表并排序返回默认会得到符合条件的前条数据副本分片可以分担搜索请求从而增加索引的副本分片数可以加大搜索的并发量但是增加副本分片并不能提升搜索请求的性能因为搜索用到的分片数并没有减少使用路由条件搜索减少搜索请求要到的分片数可以明显提高搜索性能索引数据一个索引相当于关系数据库的一张表定义索引结构忽略该字段不合法或错误的输入主分片的数量是静态配置索引创建之后不得修改副本的分片数量是动态配置索引映射创建之后可以继续给映射添加新的字段但是旧的字段无法删除和更改索引创建之后修改副本数量查看索引的映射映射支持的字段类型文本类型文本类型是一种默认会被分词的字段类型默认会使用标准分词器切分文本并会把切分后的文本保存到索引中数值类型支持不同精度的数值型数据存放整数和浮点数和数据类型保持一致日期类型索引中的日期默认为时间格式比北京时间晚可以使用参数组定义时间格式底层会转成长整形进行存储关键字类型用于保存不经过分析处理的原始文本常用于进行精准匹配查询布尔类型经纬度类型对象类型可以把一个对象作为一个字段写入到索引对象还可以继续嵌套对象嵌套对象导致一个对象不可以作为一个独立单元进行检索会影响搜索结果的准确性数组类型可以把多个同类型数据放在同一个字段中二进制文件类型不能作为检索和统计分析的条件检索时即希望对文本数据做分词处理又不想使用部分此的类型字段做统计分析和精确搜索可以给类型字段添加一个参数指定时间格式假如需要检索时即希望对文本数据做分词处理又想用不分词的类型的字段拥有最大长度上限个字符面的内容会被忽略如果某个字段写入的数据和映射定义的字段类型不匹配就会导致数据写入失败如果某个字段的数据不合法也要保证不影响其他字段的写入可以在映射中使用参数来实现可以开启索引级别的设置可以将设置为索引级别字段复制和字段存储允许在映射中为某个字段定义参数以实现复制多个其它字段的内容这样在搜索一个字段时能同时达到搜索多个字段的效果使用字段复制比使用多字段匹配性能更好只能在索引的时候有效不能在已有数据的现有索引添加默认情况下除了字段外所有的字段都不会保存到磁盘上动态映射若向的索引中添加数据的字段是原先未定义的数据也可以被成功添加拥有动态映射机制会根据添加的数据内容自动识别对应的字段类型默认的字段动态映射规则动态映射机制可以把数字字符串自动映射为和类型需要设置索引的为如果不喜欢官方自带的规则可以使用动态模板来自定义映射规则创建索引使用乐观锁进行并发控制不支持事务管理由于无法保证修改请求是按顺序到达需要防止低版本的修改把高版本的数据覆盖掉在之后使用和一起实现乐观锁张三索引数据的批量写入索引数据一条一条发给这会导致发送太多的请求使得索引数据变得很慢在实际项目中经常需要使用可以批量写入的把数据一组一组提交给批量提交批量提交的操作一共种类型和操作都能往索引添加数据区别是使用操作文档主键已存在会报错会覆盖原先文档赵二李四索引重建索引使用一段时间想修改索引的静态设置但是这些设置又无法直接修改索引数据的路由规则默认情况下会使用以下公式来决定数据被写入的分片编号默认是文档的的值意味着如果主分片数量发生变化所有数据都需要重新路由可以定义为任意一个字段内容或者字符串根据业务的需要合理的定义路由值可以帮助开发人员快速的查找数据搜素的时候带上路由值就可以到指定的分片上查询数据跳过其它的分片从而提高查询性能手动指定路由值可以减少查询使用的分片数但是可能造成数据分布不均匀为了缓解这个问题提供了索引分区的设置允许使用同一路由的数据被分发到多个分片而不是一个分片通过中进行设置当配置好索引分区以后数据分片编号的计算公式就会变成自定义路由能够减少查询的分片数量从而加快速度建立一个映射规定了对索引数据进行增删改查必须提供路由值查询某个路由值检索到哪个分片张三索引别名这样一种场景假如有一个索引只有一个主分片但是时间久了以后数据量越来越大你决定为索引扩容可是又不愿意重建索引一个解决问题的办法就是你可以创建一个新的索引保存新的数据然后取一个别名同时指向这两个索引这样在检索时使用别名就可以同时检索到两个索引的数据添加别名查看别名下包含哪些索引删除别名可以使用通配符别名配合数据过滤配合使用别名和数据过滤可以达到类似于数据库视图的效果可以把查询条件放入别名这样在搜索别名时会自动带有查询条件能起到数据自动过滤的作用给别名添加查询条件上述配置之后利用别名进行查询数据就会自动使用过滤条件别名配合数据路由给索引别名指定路由值使用别名读写数据时就会自动携带配置的路由参数给索引别名指定路由值搜索和索引时配置不同的路由值可以在搜索和索引时配置不同的路由值需注意的是搜索时使用路由值可以是多个索引时使用的路由值只能有一个因为一条数据只能被写入一个分片当一个索引别名指向多个索引时如果直接使用别名写入数据会出错原因是并不知道你到底想写入哪一个索引如果想使用别名写入数据需要指定写入的具体索引的名称配置别名中可写入的索引指定写入具体索引的名称滚动索引当一个索引数据量太大时继续写入数据可能导致分片容量过大查询时会因内存不足导致集群崩溃为了避免所有的数据都写入同一索引可以考虑使用滚动索引滚动索引需要配合索引别名一起使用可实现把原先写入一个索引的数据自动分发到多个索引中创建索引为别名创建一个滚动索引条件成立把数据写入到如果往别名中写入的索引数据量大于等于或者主分片总大小超过或者创建索引的时间长度超过天就把新的数据写入新索引的为索引指定一个规律的名称自动创建新的索引需要手动调用进行触发新索引的创建索引的状态管理管理操作分为清空缓存刷新索引冲洗索引强制合并关闭索引冻结索引清空缓存拥有很强的缓存机制可将很多数据直接放到内存大大提高查询速度使用的缓存分为节点的查询缓存分片的请求缓存字段数据加缓存字段数据是一种缓冲于内存中的数据结构他是一个文档主键指向每个字段数据的映射每个字段的数据缓存在中用于高性能的排序和聚集统计清空字段数据缓存清空节点的的查询缓存清空分片的请求缓存清除指定索引缓存清除所有索引的缓存查询缓存作用查询缓存用于存储查询请求的结果集的缓存机制它可以缓存已执行查询的结果以便相同查询被多次执行时可以直接返回缓存的结果而无需再次执行相同的查询分片的请求缓存作用分片的请求缓存是在分片级别存储请求的缓存它可以缓存已处理的请求以便相同的请求被多次发送到相同的分片时可以直接返回缓存的结果字段数据加缓存作用字段数据加缓存用于缓存字段的值例如在聚合操作中使用的字段它可以缓存字段的位移列表以及统计信息以便在聚合操作期间快速访问这些信息刷新索引当外部数据写入索引时数据并不会直接提交到磁盘上因为提交数据的过程成本高会按照一定的流程周期性地提交到磁盘进行持久化整个过程的实现步骤将索引写入内存中的缓存区和事务日志此时数据不能搜索到刷新索引数据将缓冲区的数据写入文件系统缓存此时数据已经能被搜索到冲洗索引数据把文件系统缓存中的数据写入磁盘并清空事务日志完成数据提交默认清空下会对过去内被搜索的索引提供自动化刷新机制默认间隔默认为设置刷新间隔手动刷新刷新全部索引刷新缓存是比较耗性能的操作在实际项目中应尽量避免手动刷新索引直接使用默认的刷新机制冲洗索引刷新索引把数据写入内存冲洗索引把数据存储到外存由于把数据逐条存储到外存比较耗费性能使用了事务日志来记录每个写入的请求信息冲洗索引时会一次性把文件系统缓存的数据写入磁盘然后把事务日志清空这个过程默认是每隔一段时间自动完成的如果突然宕机它会在下次启动时自动将事务日志中的数据恢复到磁盘上从而最大限度地减少数据丢失冲洗索引冲洗全部索引强制合并一个的索引可以有一到多个主分片每个主分片时一个索引一个索引又包含一到多个段当删除索引文档时数据不会彻底从磁盘删除计算机只会对删除文档做一个删除标记而强制合并索引时会把分片内部很多零散的小段合并成打断并去除被删除的文档好处每个分片中的段会减少并会腾出被删除文档所占据的外存空间段的合并是比较耗时的会自动在后台进行强制合并触发所有索引进行强制合并删除数据之后想立即腾出外存空间关闭索引部分索引在业务中不需要使用但是又不能够将其直接删除这是可以使用关闭索引的操作使索引不再接收读写请求索引被关闭后该索引在集群中相关的内部数据也会被销毁这有利于减少集群的负担关闭索引重新打开索引冻结索引集群中的旧索引不再有新的数据写入它们查询频率很低但是又不能直接关闭它们可以考虑使用冻结索引索引一旦被冻结就会变成只读的查询时会实时构建冻结索引的每个分片的瞬态数据结构并在搜索完成后立即丢弃这些数据结构这样可以避免大量的旧索引占用集群的频率拖累整体的查询性能由于被冻结索引查询的频率很低即使响应速度稍慢也是可以接收的冻结索引解冻索引索引的块索引的块能够阻塞某个索引上的读请求或者写请求使得索引成为只读或者只写的状态通过改变一些索引的动态设置来配置索引的块设置为索引及元数据变为只读状态不可写入和删除设置为索引及元数据变为只读状态不可写入但可以删除设置为禁止索引的读取操作设置为禁止索引的写入操作但是可以写入元数据设置为阻止读写元数据设置动态配置索引模板索引模板可以方便为某一类索引自动配置某些共同的参数设置索引模板可以匹配的索引名优先级值越大优先级越高版本保存元数据查询索引模板删除索引模板可以在创建索引时覆盖索引模板的内容使用模板组件简化模板配置可以把常规的索引设置映射的内容写成可复用的模板组件然后再索引模板中引用这些组件创建模板组件删除获取模板组件创建索引模板加载模板组件多个组件模板存在重复配置内容后面的组件模板会覆盖前面的组件模板配置索引的监控使用的监控端口可以直到索引运行的状态和统计指标监控索引的健康状态索引的健康状态如果存在主分片没有分配如果存在副本分片没有分片都分配了监控索引分片的段数据一个索引的分片对应一个索引一个索引由多个段构成查看每个分片的段信息按照分片查看段信息监控索引分片的分配查看索引每个分配的分配结果查看索引中已经分配过的分配所在位置不显示未分配的分配所处的位置监控索引分配的恢复查看分片恢复情况查看分片回复的更多细节信息包含分配恢复过程中的统计信息恢复了多少个文件占用空间恢复事务日志的个数监控索引的统计指标查看每个索引的统计信息控制索引分片的分配通过配置对集群的所有索引生效文本分析文本分析的原理一个完整的文本分析过程需要经过大于等于零个字符过滤器一个分词器大于等于零个分词过滤器的处理过程文本分析的顺序是先进行字符过滤器的处理然后就是分词器的处理最后是分词过滤器的处理字符过滤器用于对初始文本做简单的字符过滤和转换例如内置的字符过滤器可以用于方便的剔除文本中的标签分词器分词器的功能就是把原始文本按照一定规则分成一个个单词分词效果和分词器的类型有关分词器会保存每个关键字在初始文本中出现的位置数据分词过滤器用于对用分词器切词后的单词进行进一步的过滤和转换为了保证搜索效果的一致性索引时的分析器和全文检索时的分词器一般会设置相同的标准分析器标准分析器时文本分析默认的分析器标准分析器的内部包含一个标准分词器和一个小写分词过滤器使用指定分析器对分本进行分析头条新闻给索引设置分词器切词的最大长度设置数字和英文长度都会被切分为不超过个字符的形式自动过滤英文的停用词简单分析器简单分析器只由一个小写分词器组成它的功能是将文本在任意非字母字符出进行切分丢弃非字符字符数字空格连字符并将大写字母转换为小写字母空格分析器由一个空格分词器构成他会在所有出现空格的地方切词而每个分词本身的内容不变分析器分析文本分词器提供了两种分析器和分析器切出来的分词更多更便于被搜索到索引时的文本分析使用更加合适全文检索时的文本分析使用较为多见默认索引分析器默认全文检索分析器分词器可以识别很多中文词但是无法自动发现新词如果想拓展词典则需要进行配置自定义文本分析器分析文本字符过滤器字符过滤器去掉文本中的标签还可以解析转义字符串指定字符过滤器指定分词器指定分词过滤器映射字符过滤器根据提供的字符映射将文本中出现的字符转换为映射的另一种字符模式替换字符过滤器根据指定的正则表达式把匹配的文本转换为指定的字符串分词器分词器是把原始分本切分为一个个分词通常分词器会保存分本分析后的每个分词的相对顺序主要用于短语搜索和单词领近搜索字符偏移量记录分词在原始文本中出现的位置分词类型记录分词的终类例如单词数字等面向单词的分词器部分单词分词器会把完整的单词按照某种规则切分为一些字符串碎片搜索时可用于部分匹配主要分为元语法分词器和侧边元语法分词器每个词的最小长度每个词的最大长度只保留字母作为分词侧边元语法分词器和元语法分析器的区别在于分词总是从第一个字母开始会保留一定长度的前缀字符适合做前缀匹配特定结构的分词器分词过滤器分词过滤器用于对分词后的文本做进一步处理例如删除停用词添加同义词把字母转换为小写元语法分词过滤器将分词之后的单词进行切分侧边元语法分词过滤器类似上面的分词器词源分词过滤器把每个分词转换成对应的原型去掉复数和时态停用词分词过滤器过滤掉分词中无实际意义的停用词可以自定义黑名单进行过滤是一个着的年武汉是一个很大的城市自定义分析器是一个着的查看文档得到词条向量词条向量可以反应某个文档各个分词在索引中出现的次数位置等统计信息分为词条信息记录文档每个分词在查询参数所指定字段出现的频次位置偏移量负载用户自定义的数据信息词条统计信息统计文档的各个分词在多少个索引文档中出现以及各个分词在索引中一共出现多少次字段统计信息统计索引中拥有查询参数所指定字段的文档数据该指定字段的所有词条在索引中出现的文档数之和以及该指定字段的所有词条在索引中出现的频次之和添加词条向量餐宿查看文档的词条向量信息自定义文档词条向量类型字段的标准化这里的类型的字段做文本预处理它可以实现在文本内容写入类型前对文本进行统一的标准化转换保证写入类型字段和统一和规范查看索引中字段的真实数据搜索数据提供领域特定语言查询语句使用字符串来定义每个查询请求查询类型基本分为查询直接查询索引的全部数据默认返回前个文档每个文档的得分被设置为精准级查询查询对象大多数是非类型字段直接匹配字段中的完整内容在这个过程中不会对搜索内容进行文本分析全文检索查询对象一般是类型字段搜索内容和索引数据都会进行文本分析可以通过传参改变搜索时采用的分析器经纬度搜索针对经纬度字段的搜索搜索范围可以是圆形矩形和多边形父子关联搜索针对索引间的父子关系进行查询可以以父搜子复合搜索符合搜索允许按照某种逻辑组织多个单一搜索语句从而使搜索结果合并得到最终的结果精确查询张三花费毫秒数搜索使用分片数一共搜索到的结果相关得分的最大值原始数据张三最好不要在精确级查询的字段中使用字段因为字段会被分词可能什么也差不到多术语查询张三王五主键查询范围查询时区转换表示时间对应的是东八区存在查询筛选某个字段不为空的文档类似于的语句的作用前缀搜索用于搜索某个字段的前缀与搜索内容匹配的文档前缀查询比较耗费性能如果是字段你可以在映射中配置参数它会把每个分词的前缀字符写入索引从而大大加快前缀查询的速度配置每个分词保留前缀的长度如果前缀搜索的字段类型不是而是就不能使用参数字段的前缀搜索比较耗费性能不宜大量使用正则查询允许查询寻内容是正则表达式他会查询出某个字段符合正则表达式的所有文档大通配符查询允许在查询代码中添加两种通配符可以匹配任意长度的任意字符串可配置任意单个字符大前缀搜索和正则搜索性能消耗很大全文检索会对检索内容和检索字段进行分本分析分析器的选择对搜索结果会产生重要的影响匹配搜索匹配搜索和术语查询不一样匹配搜索会比较搜索词和每个文档的相似度只要搜索词能名中文档的分词就会被搜索到而要么搜不到要么搜到的内容就和索引内容一摸一样武汉浙大搜索支持添加多个搜索词中间用空格隔开默认逻辑连接词是可以通过配置连接词布尔前缀匹配搜索布尔前缀匹配搜索会在搜索文本经过分析后将前面的每个分词转化为进行最后一个分词转换为多个查询之间的布尔逻辑连接关系是武大大学武汉被转换为武大大学武汉短语搜索短语搜索会对搜索文本进行文本分析然后到索引中寻找搜索的每个分词并要求分词相邻可以通过调整参数设置分词出现的最大间隔距离段语前缀匹配搜索段语前缀搜索会首先对搜索文本进行分词然后将前面的分词作为短语进行搜索将最后一个分词作为前缀进行搜索多字段匹配搜索用同一段文本同时检索多个字段如果不指定字段名将默认搜索全部字段多字段匹配搜索有种类型查询字符串搜索为开发人员提供的功能较为强大的检索方法它可以传入一个复杂的字符串可以包含逻辑表达式通配符正则表达式也可以通过参数指定检索字段汉大如果是想要段语搜索的效果需要将每个索引词用索引标识起来汉大使用不同的分析器会造成不同的搜索结果将字符串切分到最细粒度再配合使用引号就能最大限度地实现开发中的全文检索而且每个检索结果都是以段语相邻地方式出现这种方法可以用于手机身份证号的检索经纬度搜索圆形搜索用于搜索距离某个圆心一定长度的检索半径之内的全部数据传参时需要传入圆心坐标和检索半径北京上海天津顺义石家庄香港杭州青岛半径圆心矩形搜索矩形搜索需要提供左上角和右下角的经纬度坐标多边形搜索多边形搜索需要传入至少个坐标点的数据会搜索出坐标点围成的多边形范围内的数据复合搜索将之前所有单一功能组织多条不同的搜索语句这种搜索就是复合搜索布尔查询按照布尔逻辑条件组织多条查询语句只有符合整个布尔条件的文档才会被搜索出来分为两种不同上下文搜索上下文使用搜索上下文需要计算每个文档与搜索条件的相关度得分这个得分的计算需要使用一套复杂的计算公式有一定的性能开销带文本分析的全文检索的查询语句很适合放在搜索上下文中过滤上下文使用过滤上下文只需要判断搜索条件跟文档数据是否匹配过滤上下文不需要计算相关度得分还可以使用缓存加快相应速度很多术语级查询语句都适合放在过滤上下文中张刘赵通用查询结构模板推荐把需要文本分词的检索条件放到里面把不需要分词的检索条件放到刘王张控制条件至少需要匹配的数量控制条件至少需要匹配的数量如果布尔查询存在或字句则该值默认为否则该值默认为同时可以设置为百分比的形式小数向下取整常量得分查询常量得分查询本质是过滤上下文不会对文档计算相关度得分每个搜索结果的得分会被赋值成请求传入的常数默认每个文档的得分都是可以控制文档的赋值析取最大查询析取最大查询允许添加多个查询条件符合任意条件的文档就会被搜索到每个文档的相关度得分取匹配搜索条件最大的哪一个值某些文档可能会同时匹配多个搜索条件但可能由于得分不高而无法排名靠前这是可以在查询中添加参数将其它匹配的查询得分也计入在内值越大文档匹配的查询条件越多排名就越靠前指定查询条件至少满足一个条件的文档才会被查询出来火车相关度增强查询相关度增强查询包含一个查询条件和一个查询条件该查询会返回所有匹配查询条件的相关文档在这些返回文档中匹配查询条件的文档相关度得分会降低得分降低的程度可以使用参数进行控制车满足查询条件搜索结果的文档相关度搜索结果的总数开始搜索结果中的带有和两个字段当总数为准确这样是为了不需要搜索结果准确时提高查询性能总是可以获取到准确总数搜索结果分页支持普通分页滚动分页和分页普通分页如果起始位置的偏移量太大分页速度会变得很慢滚动分页会在开始分页时产生一个数据快照每个分页请求会返回一个使用就能获取下一页的数据可以用于深度分页原理是利用上次分页的最后一条记录获取下一页的数据普通分页页面大小偏移量默认情况下的值超过会报错不推荐使用这种方式进行深度分页如果一定要使用这种方式分页需要设置的值滚动分页发动滚动分页请求时需要用指定每次滚动的页面大小在请求中加入一个参数代表滚动分页上下文保存时间如果超过指定时间不往下滚动则会因上下文过期而无法拉取到下一页的数据上述查询方式只要在以内发送请求以得到下一页数据滚动分页就会中断滚动分页虽然可以用于深度分页但是一旦开启新的请求对数据的改变就无法被查询到不适合实时的分页查询请求只适合用于导出某个时间点的大量数据在某一次滚动分页的查询过程每个请求返回的可能会发生变化一定要使用最后一次请求得到的滚动分页产生的分页上下文会占用一些系统资源默认超过期限会被系统自动回收为了减少资源占用可以手动回收清除全部滚动分页上下文分页滚动分页无法显式最新的数据分页则可以有效避免这个问题它的原理是每次根据上一次分页的最后一条记录的位置来寻找下一页的记录使用时先发起一个查询获取第一页的数据与普通分页的区别在于这个查询请求必须添加一个唯一字段进行排序关注最后一条数据的值参数必须为排序字段必须唯一不然会因为该字段相同的数据无法决定先后顺序导致分页出错搜索结果的排序类似于的语句的作用先按按照降序排列姓名相同使用默认的排序参数表示字段为时把数据排到最后支持按照某个数组字段排序可以配置以数组的最大值最小值平均值总和中间值作为排序依据筛选搜索结果返回的字段指定返回的字段字段中不能包含映射的参数中附带的字段例如使用参数排除掉不需要的字段字段中可以包含通配符可以实现在返回的结果中查询出字段的所谓的就是字段本身的数据内容他与是一样在构建索引时索引字段的值会生成并存放在磁盘上这个值主要用于排序和聚集统计类型字段不支持值设置高亮字段武术指定标签对和两个字段进行关键字高亮高亮字段配置支持通配符搜索结果折叠想知道索引中某些字段存在哪些不同的数据类似于只保留某个字段不重复的数据选择字段进行折叠想知道每个所包含的详细数据可以使用参数来获取配置最多展示几条排序折叠效果可以嵌套到第二级但是第二级不能做处理使用折叠功能时选择的字段必须时关键字类型或者数值类型否则请求失败解释搜索结果获取一个搜索中一个文档为什么出现或不出现的原因聚集统计不仅是大数据搜索引擎同时也是大数据分析引擎它的聚集统计的端点可用于实现与统计分析有关的功能聚集分类度量聚集可以用于计算搜索结果在某个字段上的数量统计指标比如最大值最小值总和等桶聚集可以在某个字段上划定一些区间每个区间是一个桶然后按照搜索结果的文档内容把文档归类到它所属的桶中统计的结果能明确每个桶中有多少文档桶聚集还可以嵌套其它的桶聚集或者度量聚集来进行一些复杂的指标计算管道聚集管道聚集就是把桶聚集统计的结果作为输入来继续做聚集统计会在桶聚集的结果中追加额外的统计数据度量聚集用于计算搜索结果的数量指标有些度量聚集只返回一个结果有的则一次性返回多个指标结果平均值聚集用来计算索引中某个数值字段的平均值字段为的文档当作计算不关心搜索结果的请求可以把设置为可以提高统计的响应速度最大值和最小值聚集最小值获取最大值和最小值需要考虑的影响求和聚集让搜索结果在某个数值字段上求和统计聚集统计聚集可以一次性返回搜索结果在某个数值字段上的最大值最小值平均值个数总和基数聚集用于近似地计算搜索结果在某个字段有多少个基数不同数据的个数精确度可以通过阈值参数进行控制如果搜索结果基数大于可能存在误差百分比聚集用来近似地查看搜索结果中某个字段地百分比分布数据可以清洗地看出某个值以内地数据在整体数据集中地占比自定义关心区间结果表示为有百分之多少不超过多大百分比等级聚集百分比等级聚集和百分比聚集参数恰好相反传入一组值就可以看到这个值以内的数据占整体数据的百分比头部名中聚集经常用于桶聚集的子聚集使用可以先使用桶聚集将文档分发到一系列的桶中然后使用头部名中聚集展示每个桶中的前几条记录这样可以得到每个分组的效果矩证统计聚集矩证统计聚集会根据你指定的一到多个数值计算出一组数理统计学方面的指标包括总数平均值方差偏度峰度协方差相关系数要求字段类型为数值型字段桶聚集桶聚集会按照某个字段划分出一些区间把搜索结果的每个文档按照字段所在的区间划分到桶中桶聚集会返回每个桶拥有的文档数目桶聚集会返回每个桶拥有的文档数目桶的数目既可以用参数确定也可以在执行过程中按照数据内容动态生成上限是超过会报错桶聚集可以嵌套其它聚集词条聚集类似于中的做分组统计的功能会根据指定的字段内容给每个值生成一个桶并返回每个值对应值对应的文档数量只返回前三个桶支持按照桶的值排序统计错误的编解大于表示存在遗漏的词条没有返回表示除了返回的桶的数据还有多少数据没展示返回的每个桶会包含一个这个是用来区分不同桶的标识用于识别每个桶的分组依据具体含义取决于进行聚合的字段值较小时统计出的文档数量可能不准确当把设置为时该请求会到每个分片上去除每个词条前三名统计值并返回然后汇总合并得到最后结果由于是根据每个分片的局部结果进行合并可能导致最后统计出的词条总数不对也可能词条总数是对的但是数量计算得不对所以要确保得到精确的结果就应该把设置成大于等于该字段的基数但这样做需要更多的性能开销如果觉得太大时返回的桶太多也可以在参数后面添加一个值比较大的请求参数它表示去每个分片取出的词条数这样既不会影响返回的桶数目还可以提高计算精度如果想让每个桶返回被遗漏计算的最大错误数可以在请求中添加参数当发现的值大于时就有必要增加或者参数的值去掉文档少于某个值的结果按照子聚集的统计结果排序聚集统计所选择的字段一般是或者数值字段对于要进行文本分析的字段需要开启功能才能聚集统计范围聚集范围聚集需要你提供一组左闭右开的区间在返回的结果中会得到搜索结果的某个字段落在每个区间的文档数目参数用于提供区间下界用于提供区间上界统计字段可以是数值类型的字段也可以是日期类型的字段聚集类型提供区间内容每个区间会分别统计日期范围聚集要求统计的字段类型必须是日期类型默认使用时区存储时间日期范围聚集设置时区中使用时间的时间戳来保存面对时间类型的字段需要考虑时区问题索引时是否带有时区信息直方图聚集直方图聚集经常用来做一些柱状图和折线图的展示它可以选择一个数值或日期字段然后根据字段的最小值和区间步长生成一组区间统计出每个区间的文档数目指定边界上面例子代表的就是左边界可以使用参数扩大区间的边界来强制返回空桶',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-26 00:03:26',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/yangxiao.github.io/img/headimg.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/yangxiao.github.io/" accesskey="h"><div class="title">后端开发</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/yangxiao.github.io/tags/Mysql/" style="font-size: 1.05rem;">Mysql<sup>1</sup></a><a href="/yangxiao.github.io/tags/test/" style="font-size: 1.05rem;">test<sup>1</sup></a><a href="/yangxiao.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 1.05rem;">中间件<sup>3</sup></a><a href="/yangxiao.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 1.05rem;">分布式<sup>1</sup></a><a href="/yangxiao.github.io/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" style="font-size: 1.05rem;">搜索引擎<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/yangxiao.github.io/archives/2023/12/"><span class="card-archive-list-date">December 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/yangxiao.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url">中间件</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/yangxiao.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>中间件</span></a><a class="article-meta__tags" href="/yangxiao.github.io/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>搜索引擎</span></a></span></div></div><h1 class="post-title" itemprop="name headline">ElasticSearch</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2023-12-25T16:03:26.971Z" title="发表于 2023-12-26 00:03:26">2023-12-26</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2023-12-25T16:03:26.971Z" title="更新于 2023-12-26 00:03:26">2023-12-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为长沙"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>长沙</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://yangxiao23.github.io/yangxiao.github.io/2023/12/26/ElasticSearch/"><header><a class="post-meta-categories" href="/yangxiao.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url">中间件</a><a href="/yangxiao.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" tabindex="-1" itemprop="url">中间件</a><a href="/yangxiao.github.io/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" tabindex="-1" itemprop="url">搜索引擎</a><h1 id="CrawlerTitle" itemprop="name headline">ElasticSearch</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">XIAO YANG</span><time itemprop="dateCreated datePublished" datetime="2023-12-25T16:03:26.971Z" title="发表于 2023-12-26 00:03:26">2023-12-26</time><time itemprop="dateCreated datePublished" datetime="2023-12-25T16:03:26.971Z" title="更新于 2023-12-26 00:03:26">2023-12-26</time></header><h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><blockquote>
<p><code>elasticsearch.yml</code>用于配置节点的参数，<code>jvm.options</code>用来配置Elasticsearch运行时占用的堆内存大小，<code>log4j2.properties</code>用来配置Elasticsearch运行时的日志参数。可以通过调用REST接口，在节点运行时动态修改的配置叫做动态配置，配置在<code>elasticsearch.yml</code>文件中，只能在集群重启之后才能生效的配置叫做静态配置。</p>
</blockquote>
<p>修改集群配置的方法：</p>
<ul>
<li><p>调用集群节点配置的REST接口并设置配置项临时生效，该配置项在集群重启后失效。</p>
</li>
<li><p>调用集群节点配置的REST接口并设置配置项持久有效，该配置项在集群重启后依然有效。</p>
</li>
<li><p>直接把集群节点配置项写在<code>elasticsearch.yml</code>文件中。</p>
<blockquote>
<p>优先级递减。</p>
</blockquote>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//持久生效</span><br><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;persistent&quot;: &#123;</span><br><span class="line">    &quot;search.max_buckets&quot; : &quot;50000&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//临时设置</span><br><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;transient&quot;: &#123;</span><br><span class="line">    &quot;search.max_buckets&quot; : &quot;50000&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//查询配置结果</span><br><span class="line">GET /_cluster/settings</span><br></pre></td></tr></table></figure>

<ul>
<li><code>path.data</code>和<code>path.logs</code>: 用来配置数据目录和日志目录。可以配置多个目录。</li>
<li><code>bootstrap.memory_lock</code>: 操作系统内存锁的配置项，开启<code>内存锁</code>可以防止操作系统中的缓存数据被交换到外存而导致查询性能大幅下降。<code>GET /_nodes?filter_path=**.mlockall</code>可以进行查询。</li>
<li><code>network.host</code>和<code>http.port</code>: 用于把Elasticsearch的服务绑定到固定的IP地址和端口号。</li>
<li><code>discovery.seed_hosts</code>和<code>cluster.initial_master_nodes</code>: 搭建集群时，这两个配置项对于节点的发现和主节点的选举至关重要。<code>discovery.seed_hosts</code>用于配置一组IP地址或主机名，代表集群中主候选节点的列表，当一个节点启动时会尝试把该列表中各个主候选节点建立连接，如果连接成功并找到主节点就把该节点加入集群。<code>cluster.initial_master_nodes</code>用于明确的指定一组节点名称的列表，这个列表也是主候选节点的列表，ElasticSearch集群在第一次启动时会读取该列表初始化投票配置，该配置将用于主节点的选举。</li>
</ul>
<blockquote>
<p>配置JVM的堆内存： 需要根据服务器的硬件配置修改Elasticsearch运行时的JVM堆内存，以保证集群节点拥有足够的堆内存。内存设置过少，可能查询时内存不够而导致服务宕机，如果设置过大，又会超过JVM用于<code>压缩对象指针的阈值</code>而导致内存浪费。</p>
</blockquote>
<p>在配置堆内存大小的时候，需要满足以下两个条件：</p>
<ul>
<li>堆内存最大不得超过开启压缩对象指针的阈值。</li>
<li>在堆内存不超过压缩对象指针的阈值的前提下，其大小可以设置为所在节点的一半。</li>
</ul>
<p>ELasticSearch特性：</p>
<ul>
<li>分布式大数据搜索和分析引擎，很容易拓展，在海量数据场景下仍然可以保持很高的查询性能。</li>
<li>不支持事务管理。</li>
</ul>
<h2 id="深入原理"><a href="#深入原理" class="headerlink" title="深入原理"></a>深入原理</h2><blockquote>
<p>搜索引擎通常包括数据采集模块、文本分析模块、索引存储模块、搜索模块等。</p>
</blockquote>
<ul>
<li><p>数据采集模块： ElasticSearch中支持官方Beats工具、第三方ETL工具、Java客户端写入的数据。</p>
</li>
<li><p>文本分析模块： 可以将结构化数据中长文本切割分为有实际意义的词，用于可以使用切分出来的词作为查询条件搜索到该文本。</p>
</li>
<li><p>索引存储模块： 负责将数据采集模块写入的数据按照定义好的结构写入索引。搜索引擎的索引的数据按照<code>倒排索引</code>的结构进行组织。索引存储模块还管理着数据的存储方式、路由方式、事务日志、索引状态等。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231009213843.png" alt="1696858690758.png"><br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231009213918.png" alt="1696858734354.png"></p>
</li>
<li><p>搜索模块： 根据用户输出的查询文本找到索引中匹配的文档，相关度越高的文档排名越靠前。</p>
</li>
</ul>
<h3 id="ElasticSearch集群形成机制"><a href="#ElasticSearch集群形成机制" class="headerlink" title="ElasticSearch集群形成机制"></a>ElasticSearch集群形成机制</h3><p>重要概念：</p>
<ul>
<li>主节点： 每个集群有且只有一个<code>主节点</code>，主节点是整个集群的管理者，它<code>负责维护整个集群的元数据</code>，并在节点数目发生变化时及时更新集群状态然后将状态分发给集群的其他节点。主节点还<code>负责索引分片的分配</code>。</li>
<li>主候选节点： <code>集群中有权参与主节点选举的那些节点</code>。选举时，超过一半的主候选节点达成一致方能成功。<code>选举出来的主节点必须是主候选节点列表中的一个</code>。为了维护集群的正常运转，任何时候必须确保有一半以上的主候选节点在正常工作。raft算法？</li>
<li>投票配置：<code> 包含主节点选举或集群状态需要修改时可参与投票的节点列表</code>。在一般情况下，投票配置的列表与主候选节点的列表是一致的。选举主节点时，只有某个节点的得票数超过投票配置中节点数的一半，选举才能成功。你可以人工排除一些主候选节点，即不让它们参与投票。</li>
</ul>
<p>集群节点的发现、选举和引导过程：</p>
<p>集群节点引导的主要步骤：</p>
<ul>
<li>初始化投票配置：确定集群中的主候选节点的列表，将配置<code>cluster.initial_master_nodes</code>的节点列表确认为主候选列表写入投票配置。</li>
<li>选举主节点： 投票配置中的主候选节点发起主节点的选举，只要超过一半的主候选节点达成一致，则主节点选举成功</li>
<li>发现集群中其他节点： 每个节点根据配置的主候选节点列表的<code>discovery.seed_hosts</code>逐一尝试连接，如果联系到主节点就申请加入集群，主节点确认连接成功就把该节点加入集群并修改集群的状态，然后将集群的最新状态发布到其他节点中保存。</li>
<li>当所有节点都发现完毕，整个集群的状态生成结束时，待集群启动完毕就可以对外提供统一服务。</li>
</ul>
<blockquote>
<p>节点的发现过程是递归的，即使某个节点的<code>discovery.seed_hosts</code>不包含集群的主节点，只要它可以通过列表中的节点间接找到主节点，就能被主节点纳入集群。</p>
</blockquote>
<p>集群状态的发布过程：</p>
<blockquote>
<p>对于现有的集群，<code>添加和删除节点会改变集群的状态</code>，集群的状态是一种庞大的数据结构，它包含整个集群的元数据信息，当集群状态发生变化时，主节点需要把最新的状态发布给每个节点，这个过程需要经历以下两个阶段：</p>
</blockquote>
<ul>
<li><code>预提交阶段：</code> 主节点把最新的集群状态数据发布到每个节点，每个节点接收状态数据并将其保存在本地然后向主节点发送确认响应。</li>
<li>正式提交阶段： 主节点统计收到主候选节点的确认响应数量，如果超过一半的主候选节点的确认响应成功，则开始正式提交。主节点发布提交消息到集群的每个节点，通知它们应用最新的集群状态。每个节点应用最新的集群状态后，向主节点发送最终的确认响应，一旦所有的确认响应成功，则本次状态发布完成。</li>
</ul>
<blockquote>
<p>集群状态的发布具有时间限制，<strong>如果超过时间限制主节点状态没有发布成功则主节点失败，主候选节点需要重新选举新的主节点</strong>。如果某个节点的最终确认响应超过一定时间限制没有发送到主节点，则主节点认为该节点掉线，将其从集群列表删除。</p>
</blockquote>
<blockquote>
<p>主节点和非主节点每隔一段时间就会互相发送<code>心跳检测包</code>，如果某个非主节点连续多次心跳检测失败，则该节点掉线，主节点会把它从集群的状态的删除。如果主节点掉线，则需要使用投票配置重新选举出新的主节点来管理整个集群。</p>
</blockquote>
<h3 id="索引分片的分配机制"><a href="#索引分片的分配机制" class="headerlink" title="索引分片的分配机制"></a>索引分片的分配机制</h3><p>目的：使用分片分配的感知和分片分配的过滤来人工干预这个过程减少数据丢失的可能性。</p>
<blockquote>
<p>一个索引可以有多个分片。分片的分配: 集群的主节点将索引的各个分片分配到集群的各个节点上的过程。 <code>当集群的节点数目、索引的副本分片发送变化，都会触发分片的分配</code>。在这个过程中，需要把节点现有的分片移动到其他的节点上。如果在同一时刻需要移动的分片数太多且分片容量较大，则这个过程会比较耗时。</p>
</blockquote>
<blockquote>
<p>主节点分配索引分配时，默认会尽可能把同一个索引的分片分配到更多的节点上，这样在读写索引数据的时候就可以利用更多硬件资源，提升读写效率。在分配分片的过程中，<code>永远不可以把同一个索引的某个主分片和它的副本分片分配到同一个节点上，也不可以把某个主分片的多个副本分片分配到同一个节点上</code>, </p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//获取索引分片分配方案</span><br><span class="line">GET _cat/shards/allocation-test?v</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对于一个总分片数为N的索引而言，当集群节点的数目达到N之后，继续添加新节点无法再提升该索引的读写性能。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//查看索引分配原因</span><br><span class="line">GET /_cluster/allocation/explain</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index&quot;: &quot;allocation-test&quot;,</span><br><span class="line">  &quot;shard&quot; : 0,</span><br><span class="line">  &quot;primary&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分片分配的感知"><a href="#分片分配的感知" class="headerlink" title="分片分配的感知"></a>分片分配的感知</h3><blockquote>
<p>可以使用分片分配的感知，对副本分配的分配位置进行干预。分片分配的感知<code>允许把ElasticSearch的节点划分为属于不同的区域。</code>当分配一个副本分片时，不允许将他分配到它主分片所在的区域。好处是即使某个区域的节点全部挂掉，其他区域依然有相应的副本分片，不影响集群的使用。</p>
</blockquote>
<blockquote>
<p>想从集群中删除一个节点，再关闭该节点前，你想把它拥有的分片全部迁移到其他节点上，这时候就可以使用分片分配的过滤来完成。<code>分片分配的过滤</code>允许配置分片只能或不能分配到某些节点，<code>这个配置对整个集群有效。 </code><br>配置分片分配过滤，需要给每个节点定义一些属性，或者使用节点自带的属性，以便在设置过滤条件的时候区分它们。可以在elasticsearch.yml添加<code>node.attr.state:abandon</code>，然后调用rest接口</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//根据分区进行集群分片分片干扰</span><br><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123; &quot;transient&quot;:</span><br><span class="line">    &#123; </span><br><span class="line">    &quot;cluster.routing.allocation.awareness.attributes&quot;: &quot;zone&quot;,             &quot;cluster.routing.allocation.awareness.force.zone.values&quot;: &quot;zone1,zone2&quot; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//为集群配置过滤节点</span><br><span class="line">PUT _cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">   &quot;transient&quot;: &#123;</span><br><span class="line">      &quot;cluster.routing.allocation.exclude.state&quot; : &quot;abandon&quot;//过滤</span><br><span class="line">      &quot;cluster.routing.allocation.include._name&quot;: &quot;node-1, node2&quot;，//需要包含的节点</span><br><span class="line">      &quot;cluster.routing.allocation.reuqire.state&quot; : &quot;good, fine&quot;//需要包含的节点 </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引分片的恢复机制"><a href="#索引分片的恢复机制" class="headerlink" title="索引分片的恢复机制"></a>索引分片的恢复机制</h3><blockquote>
<p>ElasticSearch使用分片的恢复实现在集群节点数发生变化时也能保证索引分片的容错性和完整性。索引分片的恢复指的是在某些条件下，由于索引的分片缺失，Elasticsearch把某个索引的分片数据复制一份来得到该分片副本的过程。</p>
</blockquote>
<ul>
<li><p>分片的分配： 当集群节点数增加，需要把一个主分片副本分配到新节点上，或集群节点数减少，或某个节点配置了分配的过滤就会进行分片的分配。</p>
</li>
<li><p>增加索引的副本数： 在节点充足的情况下，增加索引的副本，必然会导致在某些节点上新增新的副本分片。</p>
</li>
<li><p>从索引备份的快照恢复数据：使用索引备份的快照进行数据恢复时，也会使用分片的恢复。<br>分片恢复分为三种不同类型：</p>
</li>
<li><p>如果分片是从本地分片复制过来，本地存储恢复</p>
</li>
<li><p>如果分片是从集群中的其他节点复制过来，对等恢复。</p>
</li>
<li><p>如果分片是从索引备份的快照文件恢复的，快照恢复。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看分片的恢复情况</span><br><span class="line">GET /_cat/recovery/recovery-test?v&amp;h=i,s,t,ty,st,snode,tnode,f,fp,b,bp</span><br></pre></td></tr></table></figure></li>
</ul>
<p>避免不必要的分片恢复</p>
<blockquote>
<p>生产环境，节点多、索引多、分片多，而且一个分片的容量可能非常大，如果某个节点临时断网或者重启集群时未及时启动所有节点导致某些节点下线又上线，带来的是新增许多不必要的分片恢复。</p>
</blockquote>
<p>-<code> 延迟分片的恢复</code>： 提供一个索引级别的动态配置，可以控制节点下线后开始分片恢复<code>index.unassigned.node_left.delayed_timeout</code>。<code>主分片的恢复不受影响</code>，影响的是副本分片的恢复。</p>
<ul>
<li><p>改变网关中触发分片恢复的条件(在elasticsearch.yml中进行配置)</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gateway.expected_data_nodes:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">gateway.recover_after_time:</span> <span class="string">5m</span></span><br><span class="line"><span class="string">gateway.recover_after_data_nodes:3</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述配置的意思是，集群启动时，先等待5个数据节点才开始分片的恢复，如果过了5min还没达到5个数据节点，只要数据节点达到三个就触发分片的恢复。<code>gateway.expected_data_nodes</code>设置为集群数据节点的总数，可以有效减少集群重启不必要的分片恢复。</p>
</blockquote>
</li>
</ul>
<h3 id="索引数据的写入过程"><a href="#索引数据的写入过程" class="headerlink" title="索引数据的写入过程"></a>索引数据的写入过程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231010000259.png" alt="1696867352704.png"></p>
<p>集群架构<br>索引一条数据的步骤：</p>
<ul>
<li>node-1接收到一个文档写入请求。</li>
<li>根据索引数据的<code>路由规则</code>计算当前文档应当写入哪一主分片，假如此时决定路由到P1，则使用传输模块把当前的写入请求转发到node-3进行写入。</li>
<li>主分片P1写入完成后，把请求转发到node-2上，将数据写入副本分片R1，使得P1和它的副本分片数据保持一致；如果主分片写入失败，直接返回False。</li>
<li>向客户端报告写入结果。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231010000900.png" alt="1696867727637.png"></li>
</ul>
<blockquote>
<p>ElasticSearch支持在一个请求写入多个文档。</p>
</blockquote>
<p>写入步骤：</p>
<ul>
<li>node-2接到一个批量写入文档的请求。</li>
<li>对写入的文档按照<code>路由规则进行分组</code>，并把请求转发到每个主分片所在的节点上。</li>
<li>在每个主分片上写入对应的文档，每个文档写入时，先写入主分片再写入副本分片，直到所有组的问答那个全部写入完毕。</li>
<li>汇总每个节点各个文档写入的结果并进行返回。</li>
</ul>
<blockquote>
<p>向索引写入数据时，总是先写入主分片在写入副本分片。批量写入能减少请求次数，推荐使用批量插入。</p>
</blockquote>
<h3 id="索引数据的搜索过程"><a href="#索引数据的搜索过程" class="headerlink" title="索引数据的搜索过程"></a>索引数据的搜索过程</h3><blockquote>
<p><code>搜索请求即可以使用主分片，也可以使用副本分片</code>。当请求选择分片时，会采取<code>轮询</code>的方式进行分片的选择，如果搜索数据时不带路由值，则需要选择包含整个索引数据的分片.</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231010001909.png" alt="1696868339217.png"><br><strong>不带路由值的搜索过程</strong>：</p>
<ul>
<li>node-1接到一个搜索请求，该请求不包含路由值，接到请求的节点成为协调节点。</li>
<li>选择搜索要用的分片。</li>
<li>再选择的每个分片上进行搜索，默认情况下，每个分片最多会搜索出匹配前10条记录作为局部结果，局部结果会交给协调节点node1</li>
<li>协调节点会汇总局部结果。按照搜索请求的参数进行排序，默认返回全局结果的前10条数据。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231010002224.png" alt="1696868533705.png"><br>带路由值的搜索过程</p>
<ul>
<li>node-1接到一个搜索请求，该请求包含路由值，该节点成为协调节点。</li>
<li>根据请求的路由值计算搜索的分片。轮询方式选择</li>
<li>再P1分片上按照搜索条件完成搜索，去除搜索结果的列表并排序返回，默认会得到符合条件的前10条数据。</li>
</ul>
<blockquote>
<p>副本分片可以分担搜索请求，从而<code>增加索引的副本分片数可以加大搜索的并发量，但是增加副本分片并不能提升搜索请求的性能</code>，因为搜索用到的分片数并没有减少。使用路由条件搜索减少搜索请求要到的分片数，可以明显提高搜索性能。</p>
</blockquote>
<h2 id="索引数据"><a href="#索引数据" class="headerlink" title="索引数据"></a>索引数据</h2><blockquote>
<p>一个索引相当于关系数据库的一张表。</p>
</blockquote>
<h3 id="定义索引结构"><a href="#定义索引结构" class="headerlink" title="定义索引结构"></a>定义索引结构</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT mysougoulog</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;:&#123;</span><br><span class="line">      &quot;number_of_shards&quot; : &quot;5&quot;,</span><br><span class="line">      &quot;number_of_replicas&quot;: &quot;1&quot; </span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">         &quot;userid&quot; :&#123;</span><br><span class="line">            &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">                &quot;ingnore_malformed&quot;:true//忽略该字段不合法或错误的输入</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>主分片的数量是静态配置，索引创建之后不得修改。副本的分片数量是动态配置。<strong>索引映射创建之后，可以继续给映射添加新的字段，但是旧的字段无法删除和更改。</strong></p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//索引创建之后，修改副本数量</span><br><span class="line">put mysougoulog/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">     &quot;number_of_replicas&quot; : &quot;2&quot;   </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//查看索引的映射</span><br><span class="line">GET mysougoulog/_mapping</span><br></pre></td></tr></table></figure>

<p>映射支持的字段类型：</p>
<ul>
<li>文本类型。文本类型是一种默认会被分词的字段类型。默认会使用标准分词器切分文本，并会把切分后的文本保存到索引中。</li>
<li>数值类型：elasticsearch支持不同精度的数值型数据，存放整数和浮点数。和java数据类型保持一致。</li>
<li>日期类型：date，索引中的日期默认为UTC时间格式，比北京时间晚8h，可以使用format参数组定义时间格式。底层会转成长整形进行存储。</li>
<li>关键字类型： 用于保存不经过分析、处理的原始文本。常用于进行精准匹配查询。</li>
<li>布尔类型</li>
<li>经纬度类型： geo_point.</li>
<li>对象类型：可以把一个JSON对象作为一个字段写入到索引，对象还可以继续嵌套对象。嵌套对象导致一个对象不可以作为一个独立单元进行检索，会影响搜索结果的准确性。</li>
<li>数组类型: 可以把多个同类型数据放在同一个字段中。</li>
<li>二进制文件类型： binary,不能作为检索和统计分析的条件。</li>
</ul>
<blockquote>
<p>检索时即希望对文本数据做分词处理，又不想使用部分此的keyword类型字段做统计分析和精确搜索，可以给text类型字段添加一个fields参数。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//指定时间格式</span><br><span class="line">PUT sougoulog-date</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;:&#123;</span><br><span class="line">     &quot;visittime&quot;: &#123;</span><br><span class="line">        &quot;type&quot;:&quot;date&quot;,</span><br><span class="line">        &quot;format&quot;:&quot;yyyy-MM-dd HH:mm:ss ||epoch_millis&quot;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; 假如需要检索时即希望对文本数据做分词处理，又想用不分词的keyword。`keyword`类型的字段拥有最大长度上限。</span><br><span class="line"></span><br><span class="line">```http</span><br><span class="line">PUT test-1</span><br><span class="line">&#123;</span><br><span class="line">   &quot;mappings&quot; : &#123;</span><br><span class="line">       &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;key&quot; : &#123;</span><br><span class="line">             &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">             &quot;fields&quot;: &#123;</span><br><span class="line">                 &quot;keyword&quot;:&#123;</span><br><span class="line">                     &quot;type&quot; : &quot;keyword&quot;,</span><br><span class="line">                     &quot;ignore_above&quot;:256 //256个字符面的内容会被忽略 </span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果某个字段写入的数据和映射定义的字段类型不匹配就会导致数据写入失败。如果某个字段的数据不合法，也要保证不影响其他字段的写入，可以在映射中使用<code>ignore_malformed</code>参数来实现。可以开启索引级别的设置<code>index.mapping.ignore_malformed</code>。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT ignore-test</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;age&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;born&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;,</span><br><span class="line">        &quot;ignore_malformed&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//可以将ignore_malformed设置为索引级别</span><br></pre></td></tr></table></figure>

<h3 id="字段复制和字段存储"><a href="#字段复制和字段存储" class="headerlink" title="字段复制和字段存储"></a>字段复制和字段存储</h3><blockquote>
<p>ElasticSearch允许在映射中为某个字段定义copy_to参数，以实现复制多个其它字段的内容，这样在搜索一个字段时能同时达到搜索多个字段的效果。使用<code>字段复制比使用多字段匹配Multi_match性能更好</code></p>
</blockquote>
<blockquote>
<p>copy_to只能在索引的时候有效，不能在已有数据的现有索引添加。 默认情况下，除了_source字段外，所有的字段都不会保存到磁盘上。</p>
</blockquote>
<h3 id="动态映射"><a href="#动态映射" class="headerlink" title="动态映射"></a>动态映射</h3><blockquote>
<p>若向Elasticsearch的索引中添加数据的字段是原先未定义的，数据也可以被成功添加。es拥有<code>动态映射机制</code>，会根据添加的数据内容自动识别对应的字段类型。</p>
</blockquote>
<p>默认的字段动态映射规则</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231010011404.png" alt="1696871623574.png"></p>
<blockquote>
<p>动态映射机制可以把数字字符串自动映射为float和long类型，需要设置索引的<code>numeric_detection</code>为true。</p>
</blockquote>
<blockquote>
<p>如果不喜欢官方自带的规则，可以使用动态模板来自定义映射规则。</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建索引</span></span><br><span class="line">PUT test<span class="number">-3</span><span class="number">-2</span><span class="number">-1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;integer&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sex&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;boolean&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">&quot;keyword&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">             <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;keyword&quot;</span><span class="punctuation">,</span></span><br><span class="line">             <span class="attr">&quot;ignore_above&quot;</span><span class="punctuation">:</span> <span class="number">256</span></span><br><span class="line">           <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;born&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;date&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;geo_point&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用乐观锁进行并发控制"><a href="#使用乐观锁进行并发控制" class="headerlink" title="使用乐观锁进行并发控制"></a>使用乐观锁进行并发控制</h3><blockquote>
<p>ElasticSearch<code>不支持事务管理</code>，由于无法保证修改请求是按顺序到达es，需要防止低版本的修改把高版本的数据覆盖 掉。es在7.9.1之后使用<code>_seq_no</code>和<code>_primary_term</code>一起实现乐观锁。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT test-3-2-1/_doc/1?if_seq_no=0&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;id&quot;:1,</span><br><span class="line">  &quot;sex&quot;: false,</span><br><span class="line">  &quot;name&quot;:&quot;张三&quot;,</span><br><span class="line">  &quot;born&quot;: &quot;2023-10-10 00:00:00&quot;,</span><br><span class="line">  &quot;location&quot;:&#123;</span><br><span class="line">    &quot;lat&quot;:11.11,</span><br><span class="line">    &quot;lon&quot;: -71.34</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引数据的批量写入"><a href="#索引数据的批量写入" class="headerlink" title="索引数据的批量写入"></a>索引数据的批量写入</h3><blockquote>
<p>索引数据一条一条发给es，这会导致发送太多的请求，使得索引数据变得很慢。在实际项目中经常需要使用可以批量写入的API把数据一组一组提交给ES。</p>
</blockquote>
<ul>
<li><p>批量提交： 批量提交的操作一共4种类型：index、create、update、delete。index和create操作都能往索引添加数据，区别是使用create操作，文档主键已存在会报错。index会覆盖原先文档。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST test-3-2-1/_bulk &#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125; &#123;&quot;id&quot;:&quot;2&quot;,&quot;name&quot;:&quot;赵二&quot;,&quot;sex&quot;:true,&quot;born&quot;:&quot;2020-09-14 00:02:20&quot;,&quot;location&quot;:&#123;&quot;lat&quot;:11.12,&quot;lon&quot;:-71.34&#125;&#125; &#123;&quot;create&quot;:&#123;&quot;_id&quot;:&quot;4&quot;&#125;&#125; &#123;&quot;id&quot;:&quot;4&quot;,&quot;name&quot;:&quot;李四&quot;,&quot;sex&quot;:false,&quot;born&quot;:&quot;2020-10-14 00:02:20&quot;, &quot;location&quot;:&#123;&quot;lat&quot;:11.12,&quot;lon&quot;:-71.34&#125;&#125; &#123;&quot;update&quot;:&#123;&quot;_id&quot;:&quot;5&quot;&#125;&#125; &#123; &quot;doc&quot; : &#123;&quot;sex&quot; : &quot;false&quot;,&quot;born&quot; : &quot;2020-01-01 00:02:20&quot;&#125; &#125; &#123;&quot;delete&quot;:&#123;&quot;_id&quot;:&quot;5&quot;&#125;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="索引重建"><a href="#索引重建" class="headerlink" title="索引重建"></a>索引重建</h3><blockquote>
<p>索引使用一段时间，想修改索引的静态设置，但是这些设置又无法直接修改。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUT newindex-3-1-3 &#123; &quot;settings&quot;: &#123; &quot;number_of_shards&quot;: &quot;5&quot;, &quot;number_of_replicas&quot;: &quot;1&quot; &#125; &#125; </span><br><span class="line">POST _reindex &#123; &quot;source&quot;: &#123; &quot;index&quot;: &quot;test-3-2-1&quot; &#125;, &quot;dest&quot;: &#123; &quot;index&quot;: &quot;newindex-3-1-3&quot; &#125; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引数据的路由规则"><a href="#索引数据的路由规则" class="headerlink" title="索引数据的路由规则"></a>索引数据的路由规则</h3><blockquote>
<p>默认情况下，es会使用以下公式来决定数据被写入的分片编号<code>shard_num = hash(_routing) % num_primary_shards</code>,默认_routing是文档的_id的值。意味着如果主分片数量发生变化，所有数据都需要重新路由。<code>_routing</code>可以定义为任意一个字段内容或者字符串，&#96;根据业务的需要合理的定义路由值，可以帮助开发人员快速的查找数据，搜素的时候带上路由值，就可以到指定的分片上查询数据，跳过其它的分片，从而提高查询性能。</p>
</blockquote>
<blockquote>
<p>手动指定路由值可以减少查询使用的分片数，但是可能造成<code>数据分布不均匀</code>。elasticsearch为了缓解这个问题，提供了<code>索引分区</code>的设置，允许使用同一路由的数据被分发到多个分片而不是一个分片通过<code>index.routing_partition_size</code>中进行设置。当配置好索引分区以后，数据分片编号的计算公式就会变成<code>shard_num = (hash(_routing) + hash(_id) % routing_partition_size) % num_primary_shards</code>。 </p>
</blockquote>
<blockquote>
<p>自定义路由能够减少查询的分片数量，从而加快速度。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//建立一个映射</span><br><span class="line">PUT test-3-3-2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_replicas&quot;: 1,</span><br><span class="line">    &quot;number_of_shards&quot;:3</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;_routing&quot;: &#123;</span><br><span class="line">      &quot;required&quot;: true //规定了对索引数据进行增删改查必须提供路由值</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">// 查询某个路由值检索到哪个分片</span><br><span class="line">GET test-3-3-2/_search_shards?routing=张三</span><br></pre></td></tr></table></figure>

<h3 id="索引别名"><a href="#索引别名" class="headerlink" title="索引别名"></a>索引别名</h3><blockquote>
<p>这样一种场景，假如有一个索引只有一个主分片，但是时间久了以后数据量越来越大，你决定为索引扩容，可是又不愿意重建索引。一个解决问题的办法就是，你可以创建一个新的索引保存新的数据，然后取一个别名同时指向这两个索引，这样在检索时使用别名就可以同时检索到两个索引的数据。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//添加别名</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">   &quot;actions&quot; :[</span><br><span class="line">       &quot;add&quot;:&#123;</span><br><span class="line">          &quot;index&quot; : &quot;logs-1&quot;,</span><br><span class="line">           &quot;alias&quot; : &quot;logs&quot;</span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">         &quot;add&quot; :&#123;</span><br><span class="line">            &quot;index&quot; : &quot;logs-2&quot;,</span><br><span class="line">            &quot;alias&quot; : &quot;logs&quot;</span><br><span class="line">         &#125; </span><br><span class="line">       &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">//查看别名下包含哪些索引</span><br><span class="line"></span><br><span class="line">GET _alias/logs</span><br><span class="line"></span><br><span class="line">//删除别名</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">   &quot;actions&quot; : [</span><br><span class="line">       &#123;&quot;remove&quot; : &#123;&quot;index&quot; : &quot;log-1&quot;, &quot;alias&quot; : &quot;logs&quot;&#125;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以使用通配符。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;logs*&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;logs&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="别名配合数据过滤"><a href="#别名配合数据过滤" class="headerlink" title="别名配合数据过滤"></a>别名配合数据过滤</h4><blockquote>
<p>配合使用别名和数据过滤可以达到类似于数据库视图的效果，可以<code>把查询条件放入别名，这样在搜索别名时会自动带有查询条件，能起到数据自动过滤的作用</code>。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//给别名添加查询条件</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">   &quot;action&quot; : [</span><br><span class="line">       &quot;add&quot; : &#123;</span><br><span class="line">         &quot;index&quot;: &quot;logs*&quot;,</span><br><span class="line">         &quot;alias&quot; : &quot;log&quot;,</span><br><span class="line">         &quot;filter&quot; : &#123;</span><br><span class="line">             &quot;range&quot; : &#123;</span><br><span class="line">                &quot;clicknum&quot; : &#123;</span><br><span class="line">                       &quot;gte&quot; : 10 </span><br><span class="line">                &#125;</span><br><span class="line">             &#125;</span><br><span class="line">          &#125; </span><br><span class="line">       &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述配置之后，利用别名进行查询数据就会自动使用过滤条件</p>
</blockquote>
<h4 id="别名配合数据路由"><a href="#别名配合数据路由" class="headerlink" title="别名配合数据路由"></a>别名配合数据路由</h4><blockquote>
<p>给索引别名指定路由值，<code>使用别名读写数据时就会自动携带配置的路由参数</code>。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//给索引别名指定路由值</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;add&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &quot;logs-1&quot;,</span><br><span class="line">        &quot;alias&quot;: &quot;logs&quot;,</span><br><span class="line">        &quot;routing&quot;: &quot;1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">//搜索和索引时配置不同的路由值</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">   &quot;actions&quot; : &#123;</span><br><span class="line">      &quot;index&quot; : &quot;logs-1&quot;,</span><br><span class="line">      &quot;alias&quot; : &quot;logs&quot;,</span><br><span class="line">      &quot;search_routing&quot; : &quot;1,2&quot;,</span><br><span class="line">      &quot;index_routing&quot; : &quot;2&quot;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以在搜索和索引时配置不同的路由值，需注意的是，搜索时使用路由值可以是多个，索引时使用的路由值只能有一个，因为一条数据只能被写入一个分片。当一个索引别名指向多个索引时，如果直接使用别名写入数据会出错，原因是Elasticsearch并不知道你到底想写入哪一个索引。如果想使用别名写入数据，需要指定写入的具体索引的名称。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//配置别名中可写入的索引</span><br><span class="line">POST /_aliases</span><br><span class="line">&#123;</span><br><span class="line">  &quot;actions&quot; : [</span><br><span class="line">     &#123;</span><br><span class="line">       &quot;add&quot; : &#123;</span><br><span class="line">           &quot;index&quot; : &quot;logs-1&quot;,</span><br><span class="line">           &quot;alias&quot; : &quot;logs&quot;,</span><br><span class="line">           &quot;is_write_index&quot; : true   //指定写入具体索引的名称</span><br><span class="line">        &#125;,</span><br><span class="line">         &quot;add&quot; : &#123;</span><br><span class="line">            &quot;index&quot; : &quot;logs-2&quot;,</span><br><span class="line">            &quot;alias&quot; : &quot;logs&quot;</span><br><span class="line">         &#125;        </span><br><span class="line">     &#125;</span><br><span class="line">  ] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="滚动索引"><a href="#滚动索引" class="headerlink" title="滚动索引"></a>滚动索引</h4><blockquote>
<p>当一个索引数据量太大时，继续写入数据可能导致<code>分片容量过大</code>，<code>查询时会因内存不足导致集群崩溃</code>。为了避免所有的数据都写入同一索引，可以考虑使用滚动索引。滚动索引需要配合索引别名一起使用，<strong>可实现把原先写入一个索引的数据自动分发到多个索引中</strong>。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//创建索引</span><br><span class="line">PUT /log1 &#123; &quot;aliases&quot;: &#123; &quot;logs-all&quot;: &#123;&#125; &#125; &#125;</span><br><span class="line">//为别名logs-all创建一个滚动索引，条件成立把数据写入到log2。</span><br><span class="line">如果往别名logs-all中写入的索引数据量大于等于1，或者主分片总大小超过5GB，或者创建索引的时间长度超过7天，就把</span><br><span class="line">新的数据写入新索引的log2。</span><br><span class="line">POST /logs-all/_rollover/log2 &#123; &quot;conditions&quot;: &#123; &quot;max_age&quot;: &quot;7d&quot;, &quot;max_docs&quot;: 1, &quot;max_size&quot;: &quot;5gb&quot; &#125; &#125;</span><br><span class="line"></span><br><span class="line">//为索引指定一个规律的名称，自动创建新的索引</span><br><span class="line">PUT /log-000001</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aliases&quot;: &#123;</span><br><span class="line">    &quot;logseries&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /logseries/_rollover</span><br><span class="line">&#123;</span><br><span class="line">  &quot;conditions&quot;:&#123;</span><br><span class="line">    &quot;max_age&quot;: &quot;7d&quot;,</span><br><span class="line">    &quot;max_docs&quot;: 1,</span><br><span class="line">    &quot;max_size&quot;: &quot;5gb&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//需要手动调用进行触发新索引的创建</span><br><span class="line">POST /logseries/_rollover</span><br></pre></td></tr></table></figure>

<h3 id="索引的状态管理"><a href="#索引的状态管理" class="headerlink" title="索引的状态管理"></a>索引的状态管理</h3><p>管理操作分为:</p>
<ul>
<li>清空缓存</li>
<li>刷新索引</li>
<li>冲洗索引</li>
<li>强制合并</li>
<li>关闭索引</li>
<li>冻结索引</li>
</ul>
<h4 id="清空缓存"><a href="#清空缓存" class="headerlink" title="清空缓存"></a>清空缓存</h4><blockquote>
<p>Elasticsearch拥有很强的缓存机制，可将很多数据直接放到内存，大大提高查询速度。elasticsearch使用的缓存分为<code>节点的查询缓存</code>，<code>分片的请求缓存</code>，<code>字段数据加缓存</code>。</p>
<p>字段数据是一种缓冲于内存中的数据结构，他是一个文档主键指向每个字段数据的映射。每个字段的数据缓存在fileddata中用于高性能的排序和聚集统计。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//清空字段数据缓存</span><br><span class="line">POST /test-3-2-1/_cache/clear?fielddata=true</span><br><span class="line">//清空节点的的查询缓存</span><br><span class="line">POST /test-3-2-1/_cache/clear?query=true</span><br><span class="line">//清空分片的请求缓存</span><br><span class="line">POST /test-3-2-1/_cache/clear?request=true</span><br><span class="line"></span><br><span class="line">//清除指定索引缓存</span><br><span class="line">POST /test-3-2-1/_cache/clear</span><br><span class="line">//清除所有索引的缓存</span><br><span class="line">POST /_cache/clear</span><br></pre></td></tr></table></figure>

<p>查询缓存：</p>
<ul>
<li>作用：查询缓存用于存储查询请求的结果集的缓存机制。它可以缓存已执行查询的结果，以便相同查询被多次执行时可以直接返回缓存的结果，而无需再次执行相同的查询。<br>分片的请求缓存：</li>
<li>作用：分片的请求缓存是在分片级别存储请求的缓存。它可以缓存已处理的请求，以便相同的请求被多次发送到相同的分片时可以直接返回缓存的结果。<br>字段数据加缓存：</li>
<li>作用: 字段数据加缓存用于缓存字段的值，例如在聚合操作中使用的字段。它可以缓存字段的位移列表以及统计信息，以便在聚合操作期间快速访问这些信息。</li>
</ul>
<h4 id="刷新索引"><a href="#刷新索引" class="headerlink" title="刷新索引"></a>刷新索引</h4><blockquote>
<p>当外部数据写入索引时，数据并不会直接提交到磁盘上，因为提交数据的过程成本高。会按照一定的流程<code>周期性</code>地提交到磁盘进行持久化。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231012023411.png" alt="1697049240992.png"></p>
<p>整个过程的实现步骤：</p>
<ul>
<li><p>将索引写入内存中的缓存区和事务日志，此时数据不能搜索到。</p>
</li>
<li><p>刷新索引数据，将缓冲区的数据写入文件系统缓存，<code>此时数据已经能被搜索到</code>。</p>
</li>
<li><p>冲洗索引数据，把文件系统缓存中的数据写入磁盘并清空事务日志，完成数据提交。</p>
<blockquote>
<p>默认清空下，elasticsearch会对过去30s内被搜索的索引提供自动化刷新机制，默认间隔默认为1s,<code>index.refresh_interval</code>设置刷新间隔。</p>
</blockquote>
</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//手动刷新</span><br><span class="line">POST /test-3-2-1/_refresh</span><br><span class="line">//刷新全部索引</span><br><span class="line">POST /_refresh</span><br></pre></td></tr></table></figure>

<blockquote>
<p>刷新缓存是比较耗性能的操作，在实际项目中应尽量避免手动刷新索引，直接使用默认的刷新机制。</p>
</blockquote>
<h4 id="冲洗索引"><a href="#冲洗索引" class="headerlink" title="冲洗索引"></a>冲洗索引</h4><blockquote>
<p>刷新索引把数据写入内存，冲洗索引把数据存储到外存。由于把数据逐条存储到外存比较耗费性能，Elasticsearch使用了<code>事务日志(translog)来记录每个写入的请求信息</code>。冲洗索引时，Elasticsearch会一次性把文件系统缓存的数据写入磁盘，<code>然后把事务日志清空</code>，这个过程默认是每隔一段时间自动完成的。如果Elasticsearch突然宕机，它会在下次启动时自动将事务日志中的数据恢复到磁盘上，从而最大限度地减少数据丢失。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//冲洗索引</span><br><span class="line">POST /test-3-2-1/_flush</span><br><span class="line">//冲洗全部索引</span><br><span class="line">POST /_flush</span><br></pre></td></tr></table></figure>

<h4 id="强制合并"><a href="#强制合并" class="headerlink" title="强制合并"></a>强制合并</h4><blockquote>
<p>一个Elasticsearch的索引可以有一到多个主分片，每个主分片时一个Lucene索引，一个Lucene索引又包含一到多个段。当删除索引文档时，数据不会彻底从磁盘删除，计算机只会对删除文档做一个删除标记。而强制合并索引时，会把分片内部很多零散的小段合并成打断并去除被删除的文档。好处：每个分片中的段会减少并会腾出被删除文档所占据的外存空间。段的合并是比较耗时的，会自动在后台进行。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//强制合并</span><br><span class="line">POST /test-3-2-1/_forcemerge</span><br><span class="line">//触发所有索引进行强制合并</span><br><span class="line">POST /_forcemerge</span><br></pre></td></tr></table></figure>

<blockquote>
<p>删除数据之后想立即腾出外存空间。</p>
</blockquote>
<h4 id="关闭索引"><a href="#关闭索引" class="headerlink" title="关闭索引"></a>关闭索引</h4><blockquote>
<p>部分索引在业务中不需要使用但是又不能够将其直接删除，这是可以使用关闭索引的操作使索引不再接收读写请求。索引被关闭后，<code>该索引在集群中相关的内部数据也会被销毁，这有利于减少集群的负担</code>。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//关闭索引</span><br><span class="line">POST /test-3-2-1/_close</span><br><span class="line">//重新打开索引</span><br><span class="line">POST /test-3-2-1/_open</span><br></pre></td></tr></table></figure>

<h4 id="冻结索引"><a href="#冻结索引" class="headerlink" title="冻结索引"></a>冻结索引</h4><blockquote>
<p>集群中的旧索引，不再有新的数据写入它们，查询频率很低但是又不能直接关闭它们。可以考虑使用冻结索引，<code>索引一旦被冻结，就会变成只读的</code>。查询时Elasticsearch会实时构建冻结索引的每个分片的瞬态数据结构，并在搜索完成后立即丢弃这些数据结构，这样可以避免大量的旧索引占用集群的频率，拖累整体的查询性能，由于被冻结索引查询的频率很低，即使响应速度稍慢也是可以接收的。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//冻结索引</span><br><span class="line">POST /test-3-2-1/_freeze</span><br><span class="line">//解冻索引</span><br><span class="line">POST /test-3-2-1/_unfreeze</span><br></pre></td></tr></table></figure>

<h3 id="索引的块"><a href="#索引的块" class="headerlink" title="索引的块"></a>索引的块</h3><blockquote>
<p>索引的块能够阻塞某个索引上的读请求或者写请求，使得索引成为只读或者只写的状态。通过改变一些索引的动态设置来配置索引的块。</p>
</blockquote>
<ul>
<li><code>index.blocks.read_only</code>: 设置为true,索引及元数据变为只读状态，不可写入和删除。</li>
<li><code>index.blocks.read_only_allow_delete</code>: 设置为true，索引及元数据变为只读状态，不可写入，但可以删除。</li>
<li><code>index.blocks.read</code>:设置为true，禁止索引的读取操作。</li>
<li><code>index.blocks.write</code>: 设置为true，禁止索引的写入操作，但是可以写入元数据。</li>
<li><code>index.blocks.metadata</code>: 设置为true,阻止读写元数据。</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//设置动态配置</span><br><span class="line">PUT test3-2-1/_settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index.blocks.read_only&quot; : &quot;true&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="索引模板"><a href="#索引模板" class="headerlink" title="索引模板"></a>索引模板</h3><blockquote>
<p>索引模板可以方便为某一类索引自动配置某些共同的参数。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;index_patterns&quot;: [  //设置索引模板可以匹配的索引名</span><br><span class="line">        &quot;service-log*&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;template&quot;: &#123;</span><br><span class="line">        &quot;settings&quot;: &#123;</span><br><span class="line">            &quot;number_of_shards&quot;: 5,</span><br><span class="line">            &quot;number_of_replicas&quot;: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;mappings&quot;: &#123;</span><br><span class="line">            &quot;properties&quot;: &#123;</span><br><span class="line">                &quot;serviceid&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;content&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">                    &quot;fields&quot;: &#123;</span><br><span class="line">                        &quot;keyword&quot;: &#123;</span><br><span class="line">                            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">                            &quot;ignore_above&quot;: 256</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;create_at&quot;: &#123;</span><br><span class="line">                    &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">                    &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;aliases&quot;: &#123;</span><br><span class="line">            &quot;service_logs&quot;: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;priority&quot;: 200,//优先级，值越大优先级越高</span><br><span class="line">    &quot;version&quot;: 3,//版本</span><br><span class="line">    &quot;_meta&quot;: &#123; //保存元数据</span><br><span class="line">        &quot;description&quot;: &quot;my custom&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//查询索引模板</span><br><span class="line">GET /_index_template/service-template</span><br><span class="line">//删除索引模板</span><br><span class="line">DELETE /_index_template/service-template</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以在创建索引时覆盖索引模板的内容。</p>
</blockquote>
<h4 id="使用模板组件简化模板配置"><a href="#使用模板组件简化模板配置" class="headerlink" title="使用模板组件简化模板配置"></a>使用模板组件简化模板配置</h4><blockquote>
<p>可以把常规的索引设置、映射的内容写成可复用的模板组件，然后再索引模板中引用这些组件。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//创建模板组件</span><br><span class="line">DELET //删除</span><br><span class="line">PUT _component_template/comp1</span><br><span class="line">&#123;</span><br><span class="line">   &quot;template&quot; : &#123;</span><br><span class="line">       &quot;mappings&quot; : &#123;</span><br><span class="line">          &quot;properties&quot; : &#123;</span><br><span class="line">             &quot;content&quot; : &#123;</span><br><span class="line">                &quot;type&quot; : &quot;text&quot;</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">//获取模板组件</span><br><span class="line">get _component_template/comp1</span><br><span class="line">//创建索引模板，加载模板组件</span><br><span class="line">PUT _index_template/infomap</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index_patterns&quot; : [&quot;loginfo*&quot;],</span><br><span class="line">  &quot;priority&quot;:200,</span><br><span class="line">  &quot;composed_of&quot; : [&quot;comp1&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>多个组件模板存在重复配置内容，后面的组件模板会覆盖前面的组件模板配置。</p>
</blockquote>
<h3 id="索引的监控"><a href="#索引的监控" class="headerlink" title="索引的监控"></a>索引的监控</h3><blockquote>
<p>使用es的监控端口可以直到索引运行的状态和统计指标</p>
</blockquote>
<h4 id="监控索引的健康状态"><a href="#监控索引的健康状态" class="headerlink" title="监控索引的健康状态"></a>监控索引的健康状态</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /_cat/indices/test3-2-1?v&amp;format=json</span><br></pre></td></tr></table></figure>

<p>索引的健康状态：</p>
<ul>
<li><p>如果存在主分片没有分配，red。</p>
</li>
<li><p>如果存在副本分片没有分片，yellow.</p>
</li>
<li><p>都分配了，green.</p>
<h4 id="监控索引分片的段数据"><a href="#监控索引分片的段数据" class="headerlink" title="监控索引分片的段数据"></a>监控索引分片的段数据</h4></li>
</ul>
<blockquote>
<p>一个索引的分片对应一个Lucene索引，一个Lucene索引由多个段构成。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//查看每个分片的段信息</span><br><span class="line">GET /_cat/segments/test-3-2-1?v&amp;format=json</span><br><span class="line">//按照分片查看_segement段信息</span><br><span class="line">GET /test-3-2-1/_sgements</span><br></pre></td></tr></table></figure>

<h4 id="监控索引分片的分配"><a href="#监控索引分片的分配" class="headerlink" title="监控索引分片的分配"></a>监控索引分片的分配</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//查看索引每个分配的分配结果，</span><br><span class="line">GET _cat/shards</span><br><span class="line">//查看索引中已经分配过的分配所在位置,不显示未分配的分配所处的位置</span><br><span class="line">GET /test3-2-1/_shard_stores</span><br></pre></td></tr></table></figure>

<h4 id="监控索引分配的恢复"><a href="#监控索引分配的恢复" class="headerlink" title="监控索引分配的恢复"></a>监控索引分配的恢复</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//查看分片恢复情况</span><br><span class="line">GET _cat/recovery</span><br><span class="line">//查看分片回复的更多细节信息</span><br><span class="line">GET /test3-2-1/_recovery</span><br></pre></td></tr></table></figure>

<blockquote>
<p>包含分配恢复过程中的统计信息，恢复了多少个文件、占用空间、恢复事务日志的个数。</p>
</blockquote>
<h4 id="监控索引的统计指标"><a href="#监控索引的统计指标" class="headerlink" title="监控索引的统计指标"></a>监控索引的统计指标</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//查看每个索引的统计信息</span><br><span class="line">GET /test3-2-1,mysougoulog/_stats_</span><br></pre></td></tr></table></figure>

<h3 id="控制索引分片的分配"><a href="#控制索引分片的分配" class="headerlink" title="控制索引分片的分配"></a>控制索引分片的分配</h3><blockquote>
<p>通过cluster.routing.allocatiob. , 配置对集群的所有索引生效。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT index-allocation/_settings</span><br><span class="line">&#123;</span><br><span class="line">   &quot;index.routing.allocation,include.zone&quot; : &quot;left,right&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="文本分析"><a href="#文本分析" class="headerlink" title="文本分析"></a>文本分析</h2><h3 id="文本分析的原理"><a href="#文本分析的原理" class="headerlink" title="文本分析的原理"></a>文本分析的原理</h3><blockquote>
<p>一个完整的文本分析过程需要经过大于等于零个字符过滤器、一个分词器、大于等于零个分词过滤器的处理过程。文本分析的顺序是先进行字符过滤器的处理，然后就是分词器的处理，最后是分词过滤器的处理。</p>
</blockquote>
<ul>
<li>字符过滤器：用于对初始文本做简单的字符过滤和转换。例如Elasticsearch内置的HTML strip字符过滤器可以用于方便的剔除文本中的HTML标签。</li>
<li>分词器：分词器的功能就是把原始文本按照一定规则分成一个个单词，分词效果和分词器的类型有关。分词器会保存每个关键字在初始文本中出现的位置数据。</li>
<li>分词过滤器：用于对用分词器切词后的单词进行进一步的过滤和转换。</li>
</ul>
<blockquote>
<p>为了保证搜索效果的一致性，索引时的分析器和全文检索时的分词器一般会设置相同的。</p>
</blockquote>
<h4 id="标准分析器"><a href="#标准分析器" class="headerlink" title="标准分析器"></a>标准分析器</h4><blockquote>
<p>标准分析器时文本分析默认的分析器，标准分析器的内部包含一个标准分词器和一个小写分词过滤器。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">//使用指定分析器对分本进行分析</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;:&quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;The 2019头条新闻 has spreda out。 &quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//给索引设置分词器</span><br><span class="line">PUT standard-text</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;my_standard_analyzer&quot;:&#123;</span><br><span class="line">         &quot;type&quot;:&quot;standard&quot;,</span><br><span class="line">         &quot;max_token_length&quot;:3,//切词的最大长度设置,数字和英文长度都会被切分为不超过3个字符的形式</span><br><span class="line">         &quot;stopwords&quot;:&quot;_english_&quot;//自动过滤英文的停用词</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;content&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;my_standard_analyzer&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="简单分析器"><a href="#简单分析器" class="headerlink" title="简单分析器"></a>简单分析器</h4><blockquote>
<p>简单分析器只由一个小写分词器组成，它的功能是将文本在任意非字母字符出进行切分，丢弃非字符字符（数字、空格、连字符），并将大写字母转换为小写字母。</p>
</blockquote>
<h4 id="空格分析器"><a href="#空格分析器" class="headerlink" title="空格分析器"></a>空格分析器</h4><blockquote>
<p>whitespace,由一个空格分词器构成，他会在所有出现空格的地方切词，而每个分词本身的内容不变。</p>
</blockquote>
<h4 id="IK分析器分析文本"><a href="#IK分析器分析文本" class="headerlink" title="IK分析器分析文本"></a>IK分析器分析文本</h4><blockquote>
<p>IK分词器提供了两种分析器：ik_smart和ik_max_word。<code>ik_max_word</code>分析器切出来的分词更多，更便于被搜索到。索引时的文本分析使用<code>ik_max_word</code>更加合适，全文检索时的文本分析使用<code>ik_smart</code>较为多见。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PUT ik-text</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;ik_max_word&quot; //默认索引分析器</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;default_search&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;ik_smart&quot;//默认全文检索分析器</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;abstract&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">        &quot;search_analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>IK分词器可以识别很多中文词，但是无法自动发现新词，如果想拓展词典，则需要进行配置。</p>
</blockquote>
<h3 id="自定义文本分析器分析文本"><a href="#自定义文本分析器分析文本" class="headerlink" title="自定义文本分析器分析文本"></a>自定义文本分析器分析文本</h3><h4 id="字符过滤器"><a href="#字符过滤器" class="headerlink" title="字符过滤器"></a>字符过滤器</h4><ul>
<li><p>HTML strip字符过滤器:去掉文本中的HTML标签，还可以解析转义字符串。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">&quot;char_filter&quot;:[&quot;html_strip&quot;],//指定字符过滤器</span><br><span class="line">&quot;tokenizer&quot;:&#123;  //指定分词器</span><br><span class="line">   &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;filter&quot;:[],//指定分词过滤器</span><br><span class="line">&quot;text&quot;:[</span><br><span class="line">      &quot;Tom &amp; Jerrey &lt; &lt;b&gt;world&lt;/b&gt;&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- 映射字符过滤器：根据提供的字符映射，将文本中出现的字符转换为映射的另一种字符。</span><br><span class="line">```http</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;char_filter&quot;: [&#123;</span><br><span class="line">    &quot;type&quot;:&quot;mapping&quot;,</span><br><span class="line">    &quot;mappings&quot;:[</span><br><span class="line">        &quot;&amp; =&gt; and&quot;</span><br><span class="line">      ]</span><br><span class="line">  &#125;],</span><br><span class="line">  &quot;tokenizer&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;filter&quot;: [],</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;Tom &amp;Jerrey&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>模式替换字符过滤器：根据指定的正则表达式把匹配的文本转换为指定的字符串。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">&quot;char_filter&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;type&quot;: &quot;pattern_replace&quot;,</span><br><span class="line">    &quot;pattern&quot;: &quot;runoo+b&quot;,</span><br><span class="line">    &quot;replacement&quot;: &quot;tomcat&quot;</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line">&quot;tokenizer&quot;: &#123;</span><br><span class="line">  &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;filter&quot;: [],</span><br><span class="line">&quot;text&quot;: [</span><br><span class="line">  &quot;runooobbbb&quot;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分词器"><a href="#分词器" class="headerlink" title="分词器"></a>分词器</h4></li>
</ul>
<blockquote>
<p>分词器是把原始分本切分为一个个分词，通常分词器会保存。</p>
</blockquote>
<ul>
<li>分本分析后的每个分词的相对顺序，主要用于短语搜索和单词领近搜索。</li>
<li>字符偏移量，记录分词在原始文本中出现的位置。</li>
<li>分词类型： 记录分词的终类，例如单词、数字等。</li>
</ul>
<p>面向单词的分词器<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231204002238.png" alt="1701620515611.png"></p>
<p>部分单词分词器</p>
<blockquote>
<p>会把完整的单词按照某种规则切分为一些字符串碎片，搜索时可用于部分匹配，主要分为N元语法分词器和侧边N元语法分词器。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;char_filter&quot;: [],</span><br><span class="line">  &quot;tokenizer&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;ngram&quot;,</span><br><span class="line">    &quot;min_gram&quot;: 2, //每个词的最小长度</span><br><span class="line">    &quot;max_gram&quot;: 3, //每个词的最大长度</span><br><span class="line">    &quot;token_chars&quot;: [  // 只保留字母作为分词</span><br><span class="line">      &quot;letter&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;filter&quot;: [],</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;tom cat8&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>侧边N元语法分词器和 N元语法分析器的区别在于，分词总是从第一个字母开始，会保留一定长度的前缀字符。 适合做前缀匹配</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;char_filter&quot;: [],</span><br><span class="line">  &quot;tokenizer&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;edge_ngram&quot;,</span><br><span class="line">    &quot;min_gram&quot;: 2,</span><br><span class="line">    &quot;max_gram&quot;: 5</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;filter&quot;: [],</span><br><span class="line">  &quot;text&quot;: [</span><br><span class="line">    &quot;tom cat8&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>特定结构的分词器<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231204002933.png" alt="1701620963158.png"></p>
<h3 id="分词过滤器"><a href="#分词过滤器" class="headerlink" title="分词过滤器"></a>分词过滤器</h3><blockquote>
<p>分词过滤器用于对分词后的文本做进一步处理，例如删除停用词、添加同义词、把字母转换为小写。</p>
</blockquote>
<ul>
<li><p>N元语法分词过滤器：将分词之后的单词进行N-gram切分</p>
</li>
<li><p>侧边N元语法分词过滤器：类似上面的分词器</p>
</li>
<li><p>词源分词过滤器：把每个分词转换成对应的原型，去掉复数和时态.(stemmer)</p>
</li>
<li><p>停用词分词过滤器：过滤掉分词中无实际意义的停用词，可以自定义黑名单进行过滤。(stop)</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">&quot;char_filter&quot;: [</span><br><span class="line">  &quot;html_strip&quot;</span><br><span class="line">],</span><br><span class="line">&quot;tokenizer&quot;: &#123;</span><br><span class="line">  &quot;type&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;max_token_length&quot;: &quot;1&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;filter&quot;: [</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;type&quot;: &quot;stop&quot;,</span><br><span class="line">    &quot;stopwords&quot;: [</span><br><span class="line">      &quot;是&quot;,</span><br><span class="line">      &quot;一&quot;,</span><br><span class="line">      &quot;个&quot;,</span><br><span class="line">      &quot;着&quot;,</span><br><span class="line">      &quot;的&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line">&quot;text&quot;: &quot;&lt;b&gt;2020年&lt;/b&gt;武汉是一个很大的城市&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义分析器</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">PUT my_analyzer-text</span><br><span class="line">&#123;</span><br><span class="line">&quot;settings&quot;: &#123;</span><br><span class="line">  &quot;analysis&quot;: &#123;</span><br><span class="line">    &quot;tokenizer&quot;: &#123;</span><br><span class="line">      &quot;my_tokenizer&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;standard&quot;,</span><br><span class="line">        &quot;max_token_length&quot;: &quot;1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;filter&quot;: &#123;</span><br><span class="line">      &quot;my_filter&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;stop&quot;,</span><br><span class="line">        &quot;stopwords&quot;: [</span><br><span class="line">          &quot;是&quot;,</span><br><span class="line">          &quot;一&quot;,</span><br><span class="line">          &quot;个&quot;,</span><br><span class="line">          &quot;着&quot;,</span><br><span class="line">          &quot;的&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;analyzer&quot;: &#123;</span><br><span class="line">      &quot;my_analyzer&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">        &quot;char_filter&quot;: &quot;html_strip&quot;,</span><br><span class="line">        &quot;tokenizer&quot;: &quot;my_tokenizer&quot;,</span><br><span class="line">        &quot;filter&quot;: &quot;my_filter&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;default_search&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&quot;mappings&quot;: &#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;content&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;abstract&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="查看文档得到词条向量"><a href="#查看文档得到词条向量" class="headerlink" title="查看文档得到词条向量"></a>查看文档得到词条向量</h3><blockquote>
<p>词条向量可以反应某个文档各个分词在索引中出现的次数、位置等统计信息，分为</p>
</blockquote>
<ul>
<li>词条信息： 记录文档每个分词在查询参数所指定字段出现的 频次、位置、偏移量、负载（用户自定义的数据信息）。</li>
<li>词条统计信息： 统计文档的各个分词在多少个索引文档中出现，以及各个分词在索引中一共出现多少次。</li>
<li>字段统计信息： 统计索引中拥有查询参数所指定字段的文档数据、该指定字段的所有词条在索引中出现的文档数之和，以及该指定字段的所有词条在索引中出现的频次之和。</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">PUT term-vector</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;analyzer&quot;: &#123;</span><br><span class="line">        &quot;fulltext_analyzer&quot;:&#123;</span><br><span class="line">          &quot;type&quot;:&quot;custom&quot;,</span><br><span class="line">          &quot;tokenizer&quot;:&quot;standard&quot;,</span><br><span class="line">          &quot;filter&quot;:[</span><br><span class="line">              &quot;type_as_payload&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;content&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;term_vector&quot;: &quot;with_positions_offsets_payloads&quot;,//添加词条向量餐宿</span><br><span class="line">        &quot;analyzer&quot;: &quot;fulltext_analyzer&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//查看文档1的词条向量信息</span><br><span class="line">GET term-vector/_termvectors/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;fields&quot; : [&quot;content&quot;],</span><br><span class="line">  &quot;offsets&quot; : true,</span><br><span class="line">  &quot;payloads&quot; : true,</span><br><span class="line">  &quot;positions&quot; : true,</span><br><span class="line">  &quot;term_statistics&quot; : true,</span><br><span class="line">  &quot;field_statistics&quot; : true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//自定义文档词条向量</span><br><span class="line">GET term-vector/_termvectors</span><br><span class="line">&#123;</span><br><span class="line">  &quot;doc&quot;: &#123;</span><br><span class="line">    &quot;content&quot;: &quot;app apple&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;offsets&quot;: true,</span><br><span class="line">  &quot;payloads&quot;: true,</span><br><span class="line">  &quot;positions&quot;: true,</span><br><span class="line">  &quot;term_statistics&quot;: true,</span><br><span class="line">  &quot;field_statistics&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="keyword类型字段的标准化"><a href="#keyword类型字段的标准化" class="headerlink" title="keyword类型字段的标准化"></a>keyword类型字段的标准化</h3><blockquote>
<p>这里的keyword类型的字段做文本预处理，它可以实现在文本内容写入keyword类型前对文本进行统一的标准化转换，保证写入keyword类型字段和统一和规范。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">PUT normalize-keyword</span><br><span class="line">&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;analysis&quot;: &#123;</span><br><span class="line">      &quot;normalizer&quot;: &#123;</span><br><span class="line">        &quot;my_normalizer&quot;: &#123;</span><br><span class="line">          &quot;type&quot;: &quot;custom&quot;,</span><br><span class="line">          &quot;char_filter&quot;: [],</span><br><span class="line">          &quot;filter&quot;: [&quot;lowercase&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;country&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;normalizer&quot;: &quot;my_normalizer&quot;,</span><br><span class="line">        &quot;store&quot;: true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//查看索引中country字段的真实数据</span><br><span class="line">POST normalize-keyword/_search &#123; &quot;stored_fields&quot;: [&quot;country&quot;] &#125;</span><br></pre></td></tr></table></figure>

<h2 id="搜索数据"><a href="#搜索数据" class="headerlink" title="搜索数据"></a>搜索数据</h2><blockquote>
<p>Elasticsearch提供领域特定语言(DSL)查询语句，使用JSON字符串来定义每个查询请求。</p>
</blockquote>
<p>查询类型基本分为：</p>
<ul>
<li>Match all查询：直接查询索引的全部数据，默认返回前10个文档，每个文档的得分被设置为1.0。</li>
<li>精准级查询：查询对象大多数是非TEXT类型字段，直接匹配字段中的完整内容，在这个过程中不会对搜索内容进行文本分析。</li>
<li>全文检索：查询对象一般是text类型字段，搜索内容和索引数据都会进行文本分析，可以通过传参改变搜索时采用的分析器。</li>
<li>经纬度搜索：针对经纬度字段geo_point的搜索，搜索范围可以是圆形、矩形和多边形。</li>
<li>父子关联搜索：针对索引间的父子关系进行查询，可以以父搜子。</li>
<li>复合搜索：符合搜索允许按照某种逻辑组织多个单一搜索语句，从而使搜索结果合并得到最终的结果。</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">//精确查询</span><br><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;name.keyword&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;张三&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 1,  //花费毫秒数</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;    </span><br><span class="line">    &quot;total&quot;: 1,  //搜索使用分片数</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: 1, //一共搜索到的结果</span><br><span class="line">      &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot;: 0.9808291,//相关得分的最大值</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;test-3-2-1&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.9808291,</span><br><span class="line">        &quot;_source&quot;: &#123;  //原始JSON数据</span><br><span class="line">          &quot;id&quot;: 1,</span><br><span class="line">          &quot;sex&quot;: true,</span><br><span class="line">          &quot;name&quot;: &quot;张三&quot;,</span><br><span class="line">          &quot;born&quot;: &quot;2020-09-08 00:02:00&quot;,</span><br><span class="line">          &quot;location&quot;: &#123;</span><br><span class="line">            &quot;lat&quot;: 41.12,</span><br><span class="line">            &quot;lon&quot;: -71.34</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>最好不要在精确级查询的字段中使用text字段，因为text字段会被分词，可能什么也差不到</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//多术语查询</span><br><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;terms&quot;: &#123;</span><br><span class="line">      &quot;name.keyword&quot;: [</span><br><span class="line">        &quot;张三&quot;,</span><br><span class="line">        &quot;王五&quot;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//主键查询</span><br><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;ids&quot;: &#123;</span><br><span class="line">      &quot;values&quot;: [&quot;1&quot;,&quot;2&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//范围查询</span><br><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;born&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: &quot;2020/09/11 00:00:00&quot;,</span><br><span class="line">        &quot;lte&quot;: &quot;2020/09/13 00:00:00&quot;,</span><br><span class="line">        &quot;format&quot;: &quot;yyyy/MM/dd HH:mm:ss&quot;,</span><br><span class="line">        &quot;time_zone&quot;:&quot;+08:00&quot; //时区转换，表示时间对应的是东八区</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//存在查询 筛选某个字段不为空的文档，类似于SQL的 is not null语句的作用</span><br><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123; </span><br><span class="line">   &quot;query&quot;:&#123;</span><br><span class="line">      &quot;exists&quot;:&#123;</span><br><span class="line">         &quot;field&quot;:&quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前缀搜索用于搜索某个字段的前缀与搜索内容匹配的文档，前缀查询比较耗费性能，如果是text字段，你可以在映射中配置index_prefixes参数，它会把每个分词的前缀字符写入索引，从而大大加快前缀查询的速度。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">PUT prefix-test</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;address&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;index_prefixes&quot;:&#123;//配置每个分词保留前缀的长度</span><br><span class="line">          &quot;min_chars&quot;:1,</span><br><span class="line">          &quot;max_chars&quot;:5</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT prefix-test/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:1&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:1,&quot;address&quot;:&quot;wuhan qingshan&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:2&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:2,&quot;address&quot;:&quot;guangzhou baiyun&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:3&#125;&#125;</span><br><span class="line">&#123;&quot;id&quot;:3,&quot;address&quot;:&quot;beijing chaoyang&quot;&#125;</span><br><span class="line"></span><br><span class="line">GET prefix-test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;prefix&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: &quot;baiy&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果前缀搜索的字段类型不是text而是keyword，就不能使用<code>index_prefixes</code>参数，keyword字段的前缀搜索比较耗费性能，不宜大量使用。</p>
</blockquote>
<blockquote>
<p>正则查询允许查询寻内容是正则表达式，他会查询出某个字段符合正则表达式的所有文档。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;regexp&quot;: &#123;</span><br><span class="line">      &quot;name.keyword&quot;: &quot;.*大.*&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>通配符查询允许在查询代码中添加两种通配符，” * “可以匹配任意长度的任意字符串，?可配置任意单个字符。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;wildcard&quot;: &#123;</span><br><span class="line">      &quot;name.keyword&quot;: &quot;?大&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前缀搜索和正则搜索性能消耗很大。</p>
</blockquote>
<h3 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h3><blockquote>
<p>ealsticsearch会对检索内容和检索字段进行分本分析，分析器的选择对搜索结果会产生重要的影响。</p>
</blockquote>
<h4 id="匹配搜索"><a href="#匹配搜索" class="headerlink" title="匹配搜索"></a>匹配搜索</h4><blockquote>
<p>匹配搜索和术语查询不一样，匹配搜索会比较搜索词和每个文档的相似度，只要搜索词能名中文档的分词就会被搜索到，而term query要么搜不到，要么搜到的内容就和索引内容一摸一样。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST ik-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;武汉　浙大&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">        &quot;operator&quot;: &quot;and&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Match搜索支持添加多个搜索词，中间用空格隔开，默认逻辑连接词是or，可以通过<code>operator</code>配置连接词。</p>
</blockquote>
<h4 id="布尔前缀匹配搜索"><a href="#布尔前缀匹配搜索" class="headerlink" title="布尔前缀匹配搜索"></a>布尔前缀匹配搜索</h4><blockquote>
<p>布尔前缀匹配搜索会在搜索文本经过分析后，将前面的每个分词转化为进行Term query，最后一个分词转换为prefix query。多个查询之间的布尔逻辑连接关系是”should”。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST ik-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_bool_prefix&quot; : &#123;</span><br><span class="line">      &quot;content&quot; : &quot;武大　大学　武汉&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//被转换为</span><br><span class="line"></span><br><span class="line">POST ik-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot; : &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;content&quot;: &quot;武大&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;term&quot;: &#123; &quot;content&quot;: &quot;大学&quot; &#125;&#125;,</span><br><span class="line">        &#123; &quot;prefix&quot;: &#123; &quot;content&quot;: &quot;武汉&quot;&#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="短语搜索"><a href="#短语搜索" class="headerlink" title="短语搜索"></a>短语搜索</h4><blockquote>
<p>短语搜索会对搜索文本进行文本分析，然后到索引中寻找搜索的每个分词并要求分词相邻，可以通过调整slop参数设置分词出现的最大间隔距离。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT ik-text/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  &quot;content&quot;:&quot;tom cat is server&quot;,</span><br><span class="line">  &quot;abstract&quot;:&quot;1092457&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST ik-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;tom server&quot;,</span><br><span class="line">        &quot;slop&quot;: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST ik-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;tom server&quot;,</span><br><span class="line">        &quot;slop&quot;: 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="段语前缀匹配搜索"><a href="#段语前缀匹配搜索" class="headerlink" title="段语前缀匹配搜索"></a>段语前缀匹配搜索</h4><blockquote>
<p>段语前缀搜索会首先对搜索文本进行分词，然后将前面的分词作为短语进行搜索，将最后一个分词作为前缀进行搜索。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST ik-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase_prefix&quot; : &#123;</span><br><span class="line">      &quot;content&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: &quot;tom cat se&quot;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多字段匹配搜索"><a href="#多字段匹配搜索" class="headerlink" title="多字段匹配搜索"></a>多字段匹配搜索</h4><blockquote>
<p>用同一段文本同时检索多个字段，如果不指定字段名，将默认搜索全部字段。多字段匹配搜索有6种类型。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231211001047.png" alt="1702224568256.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST ik-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;tom server&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;content&quot;,&quot;abstract&quot;],</span><br><span class="line">      &quot;operator&quot;: &quot;and&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;best_fields&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="查询字符串搜索"><a href="#查询字符串搜索" class="headerlink" title="查询字符串搜索"></a>查询字符串搜索</h4><blockquote>
<p>为开发人员提供的功能较为强大的检索方法，它可以传入一个复杂的字符串，可以包含逻辑表达式、通配符、正则表达式，也可以通过fields参数指定检索字段。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST my_analyzer-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;汉大 AND 804&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">//如果是想要段语搜索的效果，需要将每个索引词用索引标识起来</span><br><span class="line">POST my_analyzer-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;\&quot;汉大\&quot; AND \&quot;84\&quot;&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;my_analyzer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用不同的分析器会造成不同的搜索结果。</p>
</blockquote>
<blockquote>
<p>将字符串切分到最细粒度，再配合使用引号，就能最大限度地实现开发中的全文检索，而且每个检索结果都是以段语相邻地方式出现。这种方法可以用于手机、身份证号的检索。</p>
</blockquote>
<h3 id="经纬度搜索"><a href="#经纬度搜索" class="headerlink" title="经纬度搜索"></a>经纬度搜索</h3><h4 id="圆形搜索"><a href="#圆形搜索" class="headerlink" title="圆形搜索"></a>圆形搜索</h4><blockquote>
<p>用于搜索距离某个圆心一定长度的检索半径之内的全部数据，传参时需要传入圆心坐标和检索半径。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">PUT geo-shop</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;name&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;location&quot;:&#123;</span><br><span class="line">        &quot;type&quot;: &quot;geo_point&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT geo-shop/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;北京&quot;,&quot;location&quot;:[116.4072154982,39.9047253699]&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;上海&quot;,&quot;location&quot;:[121.4737919321,31.2304324029]&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;3&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;天津&quot;,&quot;location&quot;:[117.1993482089,39.0850853357]&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;4&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;顺义&quot;,&quot;location&quot;:[116.6569478577,40.1299127031]&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;5&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;石家庄&quot;,&quot;location&quot;:[114.52,38.05]&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;6&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;香港&quot;,&quot;location&quot;:[114.10000,22.20000]&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;7&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;杭州&quot;,&quot;location&quot;:[120.20000,30.26667]&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;8&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;青岛&quot;,&quot;location&quot;:[120.33333,36.06667]&#125;</span><br><span class="line"></span><br><span class="line">GET geo-shop/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;geo_distance&quot;: &#123;</span><br><span class="line">      &quot;distance&quot;: &quot;100km&quot;,//半径</span><br><span class="line">      &quot;location&quot;: &#123; //圆心</span><br><span class="line">        &quot;lat&quot;: 39.96820,</span><br><span class="line">        &quot;lon&quot;: 116.4107</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="矩形搜索"><a href="#矩形搜索" class="headerlink" title="矩形搜索"></a>矩形搜索</h4><blockquote>
<p>矩形搜索需要提供左上角和右下角的经纬度坐标。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET geo-shop/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot; : &#123;</span><br><span class="line">    &quot;geo_bounding_box&quot;: &#123;</span><br><span class="line">      &quot;location&quot;: &#123;</span><br><span class="line">        &quot;top_left&quot;: &#123;</span><br><span class="line">          &quot;lat&quot;: 40.82,</span><br><span class="line">          &quot;lon&quot;: 111.65</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;bottom_right&quot;: &#123;</span><br><span class="line">          &quot;lat&quot;: 36.07,</span><br><span class="line">          &quot;lon&quot;: 120.33</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多边形搜索"><a href="#多边形搜索" class="headerlink" title="多边形搜索"></a>多边形搜索</h4><blockquote>
<p>多边形搜索需要传入至少3个坐标点的数据，geo-polygon会搜索出坐标点围成的多边形范围内的数据。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST geo-shop/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;geo_polygon&quot;: &#123;</span><br><span class="line">      &quot;location&quot;: &#123;</span><br><span class="line">        &quot;points&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;lat&quot;: 39.9,</span><br><span class="line">            &quot;lon&quot;: 116.4</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;lat&quot;: 41.8,</span><br><span class="line">            &quot;lon&quot;: 123.38</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;lat&quot;: 30.52,</span><br><span class="line">            &quot;lon&quot;: 114.31</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="复合搜索"><a href="#复合搜索" class="headerlink" title="复合搜索"></a>复合搜索</h3><blockquote>
<p>将之前所有单一功能组织多条不同的搜索语句，这种搜索就是复合搜索。</p>
</blockquote>
<h4 id="布尔查询"><a href="#布尔查询" class="headerlink" title="布尔查询"></a>布尔查询</h4><blockquote>
<p>按照布尔逻辑条件组织多条查询语句，只有符合整个布尔条件的文档才会被搜索出来。</p>
</blockquote>
<p>分为两种不同上下文：</p>
<ul>
<li>搜索上下文： 使用搜索上下文，elasticsearch需要计算每个文档与搜索条件的相关度得分，这个得分的计算需要使用一套复杂的计算公式，有一定的性能开销，带文本分析的全文检索的查询语句很适合放在搜索上下文中。</li>
<li>过滤上下文：使用过滤上下文，elasticsearch只需要判断搜索条件跟文档数据是否匹配。过滤上下文不需要计算相关度得分，还可以使用缓存加快相应速度。很多术语级查询语句都适合放在过滤上下文中。<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://gitee.com/yangxiao2000/md_img/raw/master/images/20231212225628.png" alt="1702392944450.png"></li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;name&quot;: &quot;张 刘 赵&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;range&quot;: &#123;</span><br><span class="line">          &quot;age&quot;: &#123;</span><br><span class="line">            &quot;gt&quot;: 10</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;&quot;term&quot;: &#123;</span><br><span class="line">          &quot;sex&quot;: &quot;true&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;must_not&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;born&quot;: &#123;</span><br><span class="line">              &quot;value&quot;: &quot;2020-10-14 00:02:20&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">//通用查询结构模板</span><br><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &quot;hello&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;content&quot;: &quot;world&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;status&quot;: &quot;ok&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;born_date&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: &quot;2011-01-01&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>推荐把需要文本分词的检索条件放到must里面，把不需要分词的检索条件放到filter。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;should&quot;: [</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;name&quot;: &quot;刘&quot;&#125;&#125;,</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;name&quot;: &quot;王&quot;&#125;&#125;,</span><br><span class="line">        &#123;&quot;match&quot;: &#123;&quot;name&quot;: &quot;张&quot;&#125;&#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;minimum_should_match&quot; : 2 //控制should条件至少需要匹配的数量</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>minimum_should_match</code>控制should条件至少需要匹配的数量，如果布尔查询存在must或filter字句，则该值默认为1，否则该值默认为0.同时可以设置为百分比的形式，小数向下取整。</p>
</blockquote>
<h4 id="常量得分查询"><a href="#常量得分查询" class="headerlink" title="常量得分查询"></a>常量得分查询</h4><blockquote>
<p>常量得分查询本质是过滤上下文，不会对文档计算相关度得分，每个搜索结果的得分会被赋值成请求传入的常数，默认每个文档的得分都是1.0.</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;constant_score&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;term&quot;: &#123;</span><br><span class="line">          &quot;sex&quot;: &quot;false&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;boost&quot;: 1.2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>boost</code>可以控制文档的赋值。</p>
</blockquote>
<h4 id="析取最大查询"><a href="#析取最大查询" class="headerlink" title="析取最大查询"></a>析取最大查询</h4><blockquote>
<p>析取 最大查询允许添加多个查询条件，符合任意条件的文档就会被搜索到，每个文档的相关度得分取匹配搜索条件最大的哪一个值。某些文档可能会同时匹配多个搜索条件，但可能由于得分不高而无法排名靠前，这是可以在查询中添加tie_breaker参数，将其它匹配的查询得分也计入在内。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;dis_max&quot;: &#123;</span><br><span class="line">      &quot;tie_breaker&quot;: 0.7, //值越大，文档匹配的查询条件越多，排名就越靠前</span><br><span class="line">      &quot;queries&quot;: [  //指定查询条件，至少满足一个条件的文档才会被查询出来</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;keywords&quot;: &quot;火车&quot;</span><br><span class="line">       &#125;&#125;,</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;rank&quot;: &quot;1&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="相关度增强查询"><a href="#相关度增强查询" class="headerlink" title="相关度增强查询"></a>相关度增强查询</h4><blockquote>
<p>相关度增强查询(boosting query)包含一个positive查询条件和一个negative查询条件，该查询会返回所有匹配positive查询条件的相关文档，在这些返回文档中，匹配negative查询条件的文档相关度得分会降低，得分降低的程度可以使用negative_boost参数进行控制。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST sougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;boosting&quot;: &#123;</span><br><span class="line">      &quot;positive&quot;: &#123;</span><br><span class="line">        &quot;match&quot;: &#123;</span><br><span class="line">          &quot;keywords&quot;: &quot;车&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;rank&quot;: &#123;</span><br><span class="line">            &quot;lte&quot;: 10</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;negative_boost&quot;: 0.5 //满足negative查询条件搜索结果的文档相关度 * 0.5</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="搜索结果的总数"><a href="#搜索结果的总数" class="headerlink" title="搜索结果的总数"></a>搜索结果的总数</h4><blockquote>
<p>elasticsearch7.x开始，搜索结果中的total带有value和relation两个字段，当总数&lt; 10000,relation为eq，准确。 total &gt; 10000,  total  &#x3D; 10000,relation &#x3D; gte。这样是为了不需要搜索结果准确时提高查询性能。</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;match_all&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;track_total_hits&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span> <span class="comment">//总是可以获取到准确总数 </span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="搜索结果分页"><a href="#搜索结果分页" class="headerlink" title="搜索结果分页"></a>搜索结果分页</h4><blockquote>
<p>elatsicsearch支持普通分页、滚动分页和search after 分页。普通分页如果起始位置的偏移量太大，分页速度会变得很慢。滚动分页会在开始分页时产生一个数据快照，每个分页请求会返回一个scroll_id，使用scroll_id就能获取下一页的数据。。search after可以用于深度分页，原理是利用上次分页的最后一条记录获取下一页的数据</p>
</blockquote>
<h5 id="普通分页"><a href="#普通分页" class="headerlink" title="普通分页"></a>普通分页</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;:2,//页面大小</span><br><span class="line">  &quot;from&quot;: 0,//偏移量</span><br><span class="line">  &quot;track_total_hits&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>默认情况下，form + size 的值超过10000会报错，es不推荐使用这种方式进行深度分页。如果一定要使用这种方式分页，需要设置<code>index.max_result_window</code>的值。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT _settings</span><br><span class="line">&#123;</span><br><span class="line">  &quot;index.max_result_window&quot; : &quot;20000000000&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="滚动分页"><a href="#滚动分页" class="headerlink" title="滚动分页"></a>滚动分页</h5><blockquote>
<p>发动滚动分页请求时，需要用size指定每次滚动的页面大小，在请求url中加入一个scroll参数代表滚动分页上下文保存时间，如果超过指定时间不往下滚动，则会因上下文过期而无法拉取到下一页的数据。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET test-3-2-1/_search?scroll=1m</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;:2,</span><br><span class="line">  &quot;track_total_hits&quot;: true</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /_search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  &quot;scroll&quot;:&quot;1m&quot;,</span><br><span class="line">  &quot;scroll_id&quot;:&quot;FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFjNqUWxEanIzUXd5Wjl0eTlRWllVVkEAAAAAACJXkRZKWFllMWUtRlF0T2l2MjRPNWRtYVVn&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述查询方式只要在1min以内发送请求以得到下一页数据，滚动分页就会中断。滚动分页虽然可以用于深度分页，<code>但是一旦开启，新的请求对数据的改变就无法被查询到，不适合实时的分页查询请求，只适合用于导出某个时间点的大量数据</code>。</p>
</blockquote>
<blockquote>
<p>在某一次滚动分页的查询过程，每个请求返回的scroll_id可能会发生变化，一定要使用最后一次请求得到的scroll_id。</p>
</blockquote>
<blockquote>
<p>滚动分页产生的分页上下文会占用一些系统资源，默认超过期限会被系统自动回收，为了减少资源占用，可以手动回收。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_search/scroll </span><br><span class="line">&#123; &quot;scroll_id&quot; : &quot;FgluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFGRGM3hQblVCVEw1b2pZdXQxSnJlAAAAAAAACFQWRUlqTWhOckRTb3ktQmJtbzNXOEpHQQ==&quot; &#125;</span><br><span class="line"></span><br><span class="line">//清除全部滚动分页上下文</span><br><span class="line">DELETE /_search/scroll/_all</span><br></pre></td></tr></table></figure>

<h5 id="search-after分页"><a href="#search-after分页" class="headerlink" title="search after分页"></a>search after分页</h5><blockquote>
<p>滚动分页无法显式最新的数据，search after分页则可以有效避免这个问题，它的原理是每次根据上一次分页的最后一条记录的位置来寻找下一页的记录。</p>
</blockquote>
<blockquote>
<p>使用时先发起一个查询获取第一页的数据，与普通分页的区别在于，这个查询请求必须添加一个唯一字段进行排序。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;track_total_hits&quot;: true,</span><br><span class="line">  &quot;size&quot;: 1,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">//关注最后一条数据的sort值</span><br><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;track_total_hits&quot;: true,</span><br><span class="line">  &quot;size&quot;: 1,</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;id&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;asc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;search_after&quot;: [1]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>from 参数必须为0，排序字段必须唯一，不然会因为该字段相同的数据无法决定先后顺序导致分页出错。</p>
</blockquote>
<h5 id="搜索结果的排序"><a href="#搜索结果的排序" class="headerlink" title="搜索结果的排序"></a>搜索结果的排序</h5><blockquote>
<p>类似于SQL的order by语句的作用</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">   &quot;query&quot;:&#123;</span><br><span class="line">     &quot;match_all&quot; : &#123;&#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;sort&quot;:[</span><br><span class="line">     &#123; </span><br><span class="line">        &quot;name.keyword&quot;:&#123;</span><br><span class="line">            &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;age&quot;:&#123;</span><br><span class="line">           &quot;missing&quot;:&quot;_last&quot;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line">//先按name.keyword按照降序排列，姓名相同使用默认的age排序，missing参数表示字段age为null时把数据排到最后</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Elaticsearch支持按照某个数组字段排序，可以配置以数组的最大值、最小值、平均值、总和、中间值作为排序依据。</p>
</blockquote>
<h4 id="筛选搜索结果返回的字段"><a href="#筛选搜索结果返回的字段" class="headerlink" title="筛选搜索结果返回的字段"></a>筛选搜索结果返回的字段</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//指定返回的字段</span><br><span class="line">GET test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">     &quot;match_all&quot;:&#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot; : [&quot;born&quot;,&quot;name&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>_ source 字段中不能包含映射的fields参数中附带的字段。例如<code>name.keyword</code>。<br>使用excludes参数排除掉不需要的字段，字段中可以包含通配符</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST test-3-2-1/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;excludes&quot;: [</span><br><span class="line">      &quot;born&quot;,</span><br><span class="line">      &quot;id&quot;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以实现在返回的结果中查询出字段的doc value，所谓的doc value就是字段本身的数据内容，他与_source是一样。在构建索引时，索引字段的doc value值会生成并存放在磁盘上，这个值主要用于排序和聚集统计，text类型字段不支持doc value值。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST test-3-2-1/_knn_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;docvalue_fields&quot;: [</span><br><span class="line">    &quot;name.keyword&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="设置高亮字段"><a href="#设置高亮字段" class="headerlink" title="设置高亮字段"></a>设置高亮字段</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST my_analyzer-text/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;query_string&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;武术 \&quot;210\&quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;pre_tags&quot;: [  //指定标签</span><br><span class="line">      &quot;&lt;tag1&gt;&quot;  </span><br><span class="line">    ],</span><br><span class="line">    &quot;post_tags&quot;: [</span><br><span class="line">      &quot;&lt;/tag1&gt;&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;abstract&quot;: &#123;&#125;,</span><br><span class="line">      &quot;content&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对abstract和content两个字段进行关键字高亮。，高亮字段配置支持通配符*.</p>
</blockquote>
<h4 id="搜索结果折叠"><a href="#搜索结果折叠" class="headerlink" title="搜索结果折叠"></a>搜索结果折叠</h4><blockquote>
<p>想知道索引中某些字段存在哪些不同的数据。类似于”select distinct”，只保留某个字段不重复的数据。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET collapse-test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;collapse&quot;: &#123;</span><br><span class="line">    &quot;field&quot;: &quot;level&quot;//选择字段进行折叠</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>想知道每个level所包含的详细数据，可以使用Inner_hits参数来获取</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST collapse-test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;collapse&quot;: &#123;</span><br><span class="line">    &quot;field&quot;: &quot;level&quot;,</span><br><span class="line">    &quot;inner_hits&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;by_level&quot;,</span><br><span class="line">      &quot;size&quot;: 2,//配置最多展示几条</span><br><span class="line">      &quot;sort&quot;: [ &#123; &quot;score&quot;: &quot;asc&quot; &#125; ]//排序</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>折叠效果可以嵌套到第二级，但是第二级不能做inner_hits处理。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST collapse-test/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;collapse&quot;: &#123;</span><br><span class="line">    &quot;field&quot;: &quot;level&quot;,</span><br><span class="line">    &quot;inner_hits&quot;: &#123;</span><br><span class="line">      &quot;name&quot;: &quot;by_level&quot;,</span><br><span class="line">      &quot;size&quot;: 5,</span><br><span class="line">      &quot;sort&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;score&quot;: &quot;asc&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;collapse&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;score&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用折叠功能时，选择的字段必须时关键字类型或者数值类型，否则请求失败。</p>
</blockquote>
<h3 id="解释搜索结果"><a href="#解释搜索结果" class="headerlink" title="解释搜索结果"></a>解释搜索结果</h3><blockquote>
<p>获取一个搜索中一个文档为什么出现或不出现的原因。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST test-3-2-1/_explain/4</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;range&quot;: &#123;</span><br><span class="line">      &quot;born&quot;: &#123;</span><br><span class="line">        &quot;gte&quot;: &quot;2020-09-11 08:00:00&quot;,</span><br><span class="line">        &quot;lte&quot;: &quot;now/d&quot;,</span><br><span class="line">        &quot;time_zone&quot;: &quot;+08:00&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="聚集统计"><a href="#聚集统计" class="headerlink" title="聚集统计"></a>聚集统计</h2><blockquote>
<p>ElasticSearch不仅是大数据搜索引擎同时也是大数据分析引擎。它的聚集(aggregation)统计的REST端点可用于实现与统计分析有关的功能。</p>
</blockquote>
<p>聚集分类：</p>
<ul>
<li><p>度量聚集：可以用于计算搜索结果在某个字段上的数量统计指标，比如最大值、最小值、总和等。</p>
</li>
<li><p>桶聚集： 可以在某个字段上划定一些区间，每个区间是一个桶，然后按照搜索结果的文档内容把文档归类到它所属的桶中，统计的结果能明确每个桶中有多少文档。桶聚集还可以嵌套其它的桶聚集或者度量聚集来进行一些复杂的指标计算。</p>
</li>
<li><p>管道聚集： 管道聚集就是把桶聚集统计的结果作为输入来继续做聚集统计，会在桶聚集的结果中追加额外的统计数据。</p>
<h3 id="度量聚集"><a href="#度量聚集" class="headerlink" title="度量聚集"></a>度量聚集</h3></li>
</ul>
<blockquote>
<p>用于计算搜索结果的数量指标，有些度量聚集只返回一个结果，有的则一次性返回多个指标结果。</p>
</blockquote>
<h3 id="平均值聚集"><a href="#平均值聚集" class="headerlink" title="平均值聚集"></a>平均值聚集</h3><blockquote>
<p>用来计算索引中某个数值字段的平均值。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;rank_avg&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;missing&quot;: 0   //rank字段为null的文档当作0计算</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不关心搜索结果的请求，可以把size设置为0，可以提高统计的响应速度。</p>
</blockquote>
<h3 id="最大值和最小值聚集"><a href="#最大值和最小值聚集" class="headerlink" title="最大值和最小值聚集"></a>最大值和最小值聚集</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;rank_max&quot;: &#123;  </span><br><span class="line">      &quot;max&quot;: &#123;   //min最小值</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;missing&quot;: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>missing获取最大值和最小值需要考虑missing的影响。</p>
</blockquote>
<h3 id="求和聚集"><a href="#求和聚集" class="headerlink" title="求和聚集"></a>求和聚集</h3><blockquote>
<p>让搜索结果在某个数值字段上求和</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;rank_sum&quot;: &#123;</span><br><span class="line">      &quot;sum&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;missing&quot;: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="统计聚集"><a href="#统计聚集" class="headerlink" title="统计聚集"></a>统计聚集</h3><blockquote>
<p>统计聚集可以一次性返回搜索结果在某个数值字段上的最大值、最小值、平均值、个数、总和。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;rank_stats&quot;: &#123;</span><br><span class="line">      &quot;stats&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;missing&quot;: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基数聚集"><a href="#基数聚集" class="headerlink" title="基数聚集"></a>基数聚集</h3><blockquote>
<p>用于<code>近似地</code>计算搜索结果在某个字段有多少个基数（不同数据的个数）。精确度可以通过阈值参数<code>precision_threshold</code>进行控制。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;rank_cardinality&quot;: &#123;</span><br><span class="line">      &quot;cardinality&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;precision_threshold&quot;: 10  //如果搜索结果基数大于10可能存在误差</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="百分比聚集"><a href="#百分比聚集" class="headerlink" title="百分比聚集"></a>百分比聚集</h3><blockquote>
<p>用来<code>近似地</code>查看搜索结果中某个字段地百分比分布数据。可以清洗地看出某个值以内地数据在整体数据集中地占比。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;rank_percent&quot;: &#123;</span><br><span class="line">      &quot;percentiles&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;percents&quot;: [10,90] //自定义关心区间</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>结果表示为有百分之多少不超过 多大。</p>
</blockquote>
<h3 id="百分比等级聚集"><a href="#百分比等级聚集" class="headerlink" title="百分比等级聚集"></a>百分比等级聚集</h3><blockquote>
<p>百分比等级聚集和百分比聚集参数恰好相反，传入一组值，就可以看到这个值以内的数据占整体数据的百分比。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;percent_ranks&quot;: &#123;</span><br><span class="line">      &quot;percentile_ranks&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;values&quot;: [0, 1,6]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="头部名中聚集"><a href="#头部名中聚集" class="headerlink" title="头部名中聚集"></a>头部名中聚集</h3><blockquote>
<p>经常用于桶聚集的子聚集使用，可以先使用桶聚集将文档分发到一系列的桶中，然后使用头部名中聚集展示每个桶中的前几条记录。这样可以得到每个分组top-N的效果。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST sougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;groupbytime&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;visittime&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;top-N&quot;: &#123;</span><br><span class="line">          &quot;top_hits&quot;: &#123;</span><br><span class="line">            &quot;size&quot;: 2,</span><br><span class="line">            &quot;_source&quot;: &#123;</span><br><span class="line">              &quot;includes&quot;: [ &quot;keywords&quot;, &quot;rank&quot; ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;sort&quot;: [&quot;userid.keyword&quot;]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="矩证统计聚集"><a href="#矩证统计聚集" class="headerlink" title="矩证统计聚集"></a>矩证统计聚集</h3><blockquote>
<p>矩证统计聚集会根据你指定的一到多个数值计算出一组数理统计学方面的指标，包括总数、平均值、方差、偏度、峰度、协方差、相关系数。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST mysougoulog/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;matrix&quot;: &#123;</span><br><span class="line">      &quot;matrix_stats&quot;: &#123;</span><br><span class="line">        &quot;fields&quot;: [&quot;rank&quot;,&quot;clicknum&quot;]  //要求字段类型为数值型字段</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="桶聚集"><a href="#桶聚集" class="headerlink" title="桶聚集"></a>桶聚集</h3><blockquote>
<p>桶聚集会按照<code>某个字段</code>划分出一些区间，把搜索结果的每个文档按照字段所在的区间划分到桶中，桶聚集会返回每个桶拥有的文档数目。桶聚集会返回每个桶拥有的文档数目。<code>桶的数目</code>既可以用参数确定，也可以在执行过程中按照数据内容动态生成。上限是65535，超过会报错。桶聚集可以嵌套其它聚集。</p>
</blockquote>
<h4 id="词条聚集"><a href="#词条聚集" class="headerlink" title="词条聚集"></a>词条聚集</h4><blockquote>
<p>类似于SQL 中的group by做分组统计的功能，会根据指定的字段内容给每个值生成一个桶，并返回每个值对应值对应的文档数量。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">POST sougou/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_time&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;visittime&quot;, </span><br><span class="line">        &quot;size&quot;: 3,   //只返回前三个桶</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;_count&quot;: &quot;desc&quot;   // 支持按照桶的值排序</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 83,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: 10000,</span><br><span class="line">      &quot;relation&quot;: &quot;gte&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot;: null,</span><br><span class="line">    &quot;hits&quot;: []</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggregations&quot;: &#123;</span><br><span class="line">    &quot;group_by_time&quot;: &#123;</span><br><span class="line">      &quot;doc_count_error_upper_bound&quot;: 0, //统计错误的编解，大于0表示存在遗漏的词条没有返回</span><br><span class="line">      &quot;sum_other_doc_count&quot;: 19905, //表示除了返回的桶的数据，还有多少数据没展示</span><br><span class="line">      &quot;buckets&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot;: 1214668976000,</span><br><span class="line">          &quot;key_as_string&quot;: &quot;2008-06-28 16:02:56&quot;,</span><br><span class="line">          &quot;doc_count&quot;: 32</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot;: 1214669960000,</span><br><span class="line">          &quot;key_as_string&quot;: &quot;2008-06-28 16:19:20&quot;,</span><br><span class="line">          &quot;doc_count&quot;: 32</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;key&quot;: 1214669757000,</span><br><span class="line">          &quot;key_as_string&quot;: &quot;2008-06-28 16:15:57&quot;,</span><br><span class="line">          &quot;doc_count&quot;: 31</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>返回的每个桶会包含一个key，这个key是用来区分不同桶的标识，用于识别每个桶的分组依据。具体含义取决于进行聚合的字段。</p>
</blockquote>
<blockquote>
<p>size值较小时统计出的文档数量可能不准确。当把size设置为3时，该请求会到每个分片上去除每个词条前三名统计值并返回然后汇总合并得到最后结果，由于是根据每个分片的<code>局部结果进行合并</code>，可能导致最后统计出的词条总数不对。也可能词条总数是对的，但是数量计算得不对。所以，要确保得到精确的结果，就应该把size设置成大于等于该字段的基数，但这样做需要更多的性能开销。如果觉得size太大时返回的桶太多，也可以在size参数后面添加一个值比较大的请求参数<code>shard_size</code>，它表示去每个分片取出的词条数，这样既不会影响返回的桶数目，还可以提高计算精度。</p>
</blockquote>
<blockquote>
<p>如果想让每个桶返回被遗漏计算的最大错误数，可以在请求中添加参数<code>show_term_doc_count_error</code>。<br>当发现<code>doc_count_error_upper_bound</code>的值大于0时，就有必要增加size或者shard_size参数的值。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST sougou/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_time&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;visittime&quot;,</span><br><span class="line">        &quot;size&quot;: 3,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;_count&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;show_term_doc_count_error&quot;: true,</span><br><span class="line">        &quot;min_doc_count&quot;: 30 //去掉文档少于某个值的结果。</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>按照子聚集的统计结果排序</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST sougou/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;group_by_time&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;visittime&quot;,</span><br><span class="line">        &quot;size&quot;: 10,</span><br><span class="line">        &quot;order&quot;: &#123;</span><br><span class="line">          &quot;_count&quot;: &quot;desc&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;show_term_doc_count_error&quot;: true,</span><br><span class="line">        &quot;min_doc_count&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;sum_rank&quot;: &#123;</span><br><span class="line">          &quot;sum&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;rank&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>聚集统计，所选择的字段一般是data、keyword或者数值字段，对于要进行文本分析的text字段需要开启fielddata功能才能聚集统计。</p>
</blockquote>
<h4 id="范围聚集"><a href="#范围聚集" class="headerlink" title="范围聚集"></a>范围聚集</h4><blockquote>
<p>范围聚集需要你提供一组<code>左闭右开</code>的区间，在返回的结果中会得到搜索结果的某个字段落在每个区间的文档数目，参数from用于提供区间下界，to用于提供区间上界.统计字段可以是<code>数值类型</code>的字段也可以是<code>日期类型</code>的字段。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST sougou/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;range_rank&quot;:&#123; </span><br><span class="line">      &quot;range&quot;: &#123;    //聚集类型</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;ranges&quot;: [   //提供区间内容,每个区间会分别统计</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: 20</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 20,</span><br><span class="line">            &quot;to&quot;: 50</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: 50</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="日期范围聚集"><a href="#日期范围聚集" class="headerlink" title="日期范围聚集"></a>日期范围聚集</h4><blockquote>
<p>要求统计的字段类型必须是日期类型.Elasticsearch默认使用UTC时区存储时间。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST sougou/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;range_rank&quot;:&#123;</span><br><span class="line">       &quot;date_range&quot;:&#123;   //日期范围聚集</span><br><span class="line">        &quot;field&quot;: &quot;visittime&quot;,</span><br><span class="line">        &quot;time_zone&quot; : &quot;+08:00&quot; //设置时区</span><br><span class="line">        &quot;ranges&quot;: [</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;to&quot;: &quot;2020-10-12 00:00:00&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;from&quot;: &quot;2020-10-12 00:00:00&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>elasticsearch中使用UTC时间的时间戳来保存，面对时间类型的字段需要考虑时区问题，索引时是否带有时区信息。</p>
</blockquote>
<h4 id="直方图聚集"><a href="#直方图聚集" class="headerlink" title="直方图聚集"></a>直方图聚集</h4><blockquote>
<p>直方图聚集经常用来做一些柱状图和折线图的展示，它可以选择一个数值或日期字段，然后根据字段的最小值和区间步长生成一组区间，统计出每个区间的文档数目。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST sougou/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;size&quot;: 0,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;histogram_rank&quot;:&#123;</span><br><span class="line">       &quot;histogram&quot;:&#123;</span><br><span class="line">        &quot;field&quot;: &quot;rank&quot;,</span><br><span class="line">        &quot;interval&quot;: 400,</span><br><span class="line">        &quot;extended_bounds&quot;:&#123; //指定边界</span><br><span class="line">          &quot;min&quot;:0,</span><br><span class="line">          &quot;max&quot;:1500 </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面例子key代表的就是左边界，可以使用<code>extended_bounds</code>参数扩大区间的边界来强制返回空桶。</p>
</blockquote>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/yangxiao.github.io/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/yangxiao.github.io/img/headimg.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/yangxiao.github.io/img/headimg.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">XIAO YANG</div><div class="post-copyright__author_desc">笔记</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://yangxiao23.github.io/yangxiao.github.io/2023/12/26/ElasticSearch/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://yangxiao23.github.io/yangxiao.github.io/2023/12/26/ElasticSearch/')">ElasticSearch</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://yangxiao23.github.io/yangxiao.github.io/2023/12/26/ElasticSearch/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=ElasticSearch&amp;url=https://yangxiao23.github.io/yangxiao.github.io/2023/12/26/ElasticSearch/&amp;pic=" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yangxiao23.github.io/yangxiao.github.io" target="_blank">后端开发</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/yangxiao.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>中间件<span class="categoryesPageCount">1</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/yangxiao.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>中间件<span class="tagsPageCount">3</span></a><a class="post-meta__box__tags" href="/yangxiao.github.io/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>搜索引擎<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="social-share" data-image="/yangxiao.github.io/img/headimg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/yangxiao.github.io/2023/12/20/Mysql/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/yangxiao.github.io/" onerror="onerror=null;src='/yangxiao.github.io/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Mysql</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/yangxiao.github.io/2023/12/20/Mysql/" title="Mysql"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/yangxiao.github.io/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-20</div><div class="title">Mysql</div></div></a></div><div><a href="/yangxiao.github.io/2023/12/20/kafka/" title="Kafka"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/yangxiao.github.io/" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-20</div><div class="title">Kafka</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/yangxiao.github.io/img/headimg.jpg" onerror="this.onerror=null;this.src='/yangxiao.github.io/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description">后端开发记录</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">深入原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch%E9%9B%86%E7%BE%A4%E5%BD%A2%E6%88%90%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.1.</span> <span class="toc-text">ElasticSearch集群形成机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%89%87%E7%9A%84%E5%88%86%E9%85%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.2.</span> <span class="toc-text">索引分片的分配机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87%E5%88%86%E9%85%8D%E7%9A%84%E6%84%9F%E7%9F%A5"><span class="toc-number">1.1.3.</span> <span class="toc-text">分片分配的感知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%86%E7%89%87%E7%9A%84%E6%81%A2%E5%A4%8D%E6%9C%BA%E5%88%B6"><span class="toc-number">1.1.4.</span> <span class="toc-text">索引分片的恢复机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%9A%84%E5%86%99%E5%85%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.5.</span> <span class="toc-text">索引数据的写入过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%9A%84%E6%90%9C%E7%B4%A2%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.6.</span> <span class="toc-text">索引数据的搜索过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.</span> <span class="toc-text">索引数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">定义索引结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E5%A4%8D%E5%88%B6%E5%92%8C%E5%AD%97%E6%AE%B5%E5%AD%98%E5%82%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">字段复制和字段存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%98%A0%E5%B0%84"><span class="toc-number">1.2.3.</span> <span class="toc-text">动态映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B9%90%E8%A7%82%E9%94%81%E8%BF%9B%E8%A1%8C%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6"><span class="toc-number">1.2.4.</span> <span class="toc-text">使用乐观锁进行并发控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%9A%84%E6%89%B9%E9%87%8F%E5%86%99%E5%85%A5"><span class="toc-number">1.2.5.</span> <span class="toc-text">索引数据的批量写入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA"><span class="toc-number">1.2.6.</span> <span class="toc-text">索引重建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="toc-number">1.2.7.</span> <span class="toc-text">索引数据的路由规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%88%AB%E5%90%8D"><span class="toc-number">1.2.8.</span> <span class="toc-text">索引别名</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E9%85%8D%E5%90%88%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4"><span class="toc-number">1.2.8.1.</span> <span class="toc-text">别名配合数据过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%AB%E5%90%8D%E9%85%8D%E5%90%88%E6%95%B0%E6%8D%AE%E8%B7%AF%E7%94%B1"><span class="toc-number">1.2.8.2.</span> <span class="toc-text">别名配合数据路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.8.3.</span> <span class="toc-text">滚动索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">1.2.9.</span> <span class="toc-text">索引的状态管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E7%A9%BA%E7%BC%93%E5%AD%98"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">清空缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%B7%E6%96%B0%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">刷新索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%B2%E6%B4%97%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.9.3.</span> <span class="toc-text">冲洗索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E5%90%88%E5%B9%B6"><span class="toc-number">1.2.9.4.</span> <span class="toc-text">强制合并</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.9.5.</span> <span class="toc-text">关闭索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%BB%E7%BB%93%E7%B4%A2%E5%BC%95"><span class="toc-number">1.2.9.6.</span> <span class="toc-text">冻结索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E5%9D%97"><span class="toc-number">1.2.10.</span> <span class="toc-text">索引的块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="toc-number">1.2.11.</span> <span class="toc-text">索引模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%A8%A1%E6%9D%BF%E7%BB%84%E4%BB%B6%E7%AE%80%E5%8C%96%E6%A8%A1%E6%9D%BF%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.11.1.</span> <span class="toc-text">使用模板组件简化模板配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E7%9A%84%E7%9B%91%E6%8E%A7"><span class="toc-number">1.2.12.</span> <span class="toc-text">索引的监控</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E7%B4%A2%E5%BC%95%E7%9A%84%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.12.1.</span> <span class="toc-text">监控索引的健康状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E7%B4%A2%E5%BC%95%E5%88%86%E7%89%87%E7%9A%84%E6%AE%B5%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.12.2.</span> <span class="toc-text">监控索引分片的段数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E7%B4%A2%E5%BC%95%E5%88%86%E7%89%87%E7%9A%84%E5%88%86%E9%85%8D"><span class="toc-number">1.2.12.3.</span> <span class="toc-text">监控索引分片的分配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E7%B4%A2%E5%BC%95%E5%88%86%E9%85%8D%E7%9A%84%E6%81%A2%E5%A4%8D"><span class="toc-number">1.2.12.4.</span> <span class="toc-text">监控索引分配的恢复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E7%B4%A2%E5%BC%95%E7%9A%84%E7%BB%9F%E8%AE%A1%E6%8C%87%E6%A0%87"><span class="toc-number">1.2.12.5.</span> <span class="toc-text">监控索引的统计指标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E7%B4%A2%E5%BC%95%E5%88%86%E7%89%87%E7%9A%84%E5%88%86%E9%85%8D"><span class="toc-number">1.2.13.</span> <span class="toc-text">控制索引分片的分配</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">文本分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E5%88%86%E6%9E%90%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.1.</span> <span class="toc-text">文本分析的原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E5%87%86%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">标准分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">简单分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">空格分析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IK%E5%88%86%E6%9E%90%E5%99%A8%E5%88%86%E6%9E%90%E6%96%87%E6%9C%AC"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">IK分析器分析文本</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E6%9C%AC%E5%88%86%E6%9E%90%E5%99%A8%E5%88%86%E6%9E%90%E6%96%87%E6%9C%AC"><span class="toc-number">1.3.2.</span> <span class="toc-text">自定义文本分析器分析文本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">字符过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">分词器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">分词过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%96%87%E6%A1%A3%E5%BE%97%E5%88%B0%E8%AF%8D%E6%9D%A1%E5%90%91%E9%87%8F"><span class="toc-number">1.3.4.</span> <span class="toc-text">查看文档得到词条向量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#keyword%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5%E7%9A%84%E6%A0%87%E5%87%86%E5%8C%96"><span class="toc-number">1.3.5.</span> <span class="toc-text">keyword类型字段的标准化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="toc-number">1.4.</span> <span class="toc-text">搜索数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="toc-number">1.4.1.</span> <span class="toc-text">全文检索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">匹配搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">布尔前缀匹配搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%AD%E8%AF%AD%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">短语搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AE%B5%E8%AF%AD%E5%89%8D%E7%BC%80%E5%8C%B9%E9%85%8D%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">段语前缀匹配搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.1.5.</span> <span class="toc-text">多字段匹配搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.1.6.</span> <span class="toc-text">查询字符串搜索</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%8F%E7%BA%AC%E5%BA%A6%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.2.</span> <span class="toc-text">经纬度搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%86%E5%BD%A2%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">圆形搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9F%A9%E5%BD%A2%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">矩形搜索</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E8%BE%B9%E5%BD%A2%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">多边形搜索</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%90%9C%E7%B4%A2"><span class="toc-number">1.4.3.</span> <span class="toc-text">复合搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%83%E5%B0%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">布尔查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F%E5%BE%97%E5%88%86%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">常量得分查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%90%E5%8F%96%E6%9C%80%E5%A4%A7%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">析取最大查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E5%BA%A6%E5%A2%9E%E5%BC%BA%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">相关度增强查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E7%9A%84%E6%80%BB%E6%95%B0"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">搜索结果的总数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E5%88%86%E9%A1%B5"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">搜索结果分页</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E5%88%86%E9%A1%B5"><span class="toc-number">1.4.3.6.1.</span> <span class="toc-text">普通分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E5%88%86%E9%A1%B5"><span class="toc-number">1.4.3.6.2.</span> <span class="toc-text">滚动分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#search-after%E5%88%86%E9%A1%B5"><span class="toc-number">1.4.3.6.3.</span> <span class="toc-text">search after分页</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E7%9A%84%E6%8E%92%E5%BA%8F"><span class="toc-number">1.4.3.6.4.</span> <span class="toc-text">搜索结果的排序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%9B%E9%80%89%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E8%BF%94%E5%9B%9E%E7%9A%84%E5%AD%97%E6%AE%B5"><span class="toc-number">1.4.3.7.</span> <span class="toc-text">筛选搜索结果返回的字段</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%AB%98%E4%BA%AE%E5%AD%97%E6%AE%B5"><span class="toc-number">1.4.4.</span> <span class="toc-text">设置高亮字段</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C%E6%8A%98%E5%8F%A0"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">搜索结果折叠</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%87%8A%E6%90%9C%E7%B4%A2%E7%BB%93%E6%9E%9C"><span class="toc-number">1.4.5.</span> <span class="toc-text">解释搜索结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%81%9A%E9%9B%86%E7%BB%9F%E8%AE%A1"><span class="toc-number">1.5.</span> <span class="toc-text">聚集统计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%A6%E9%87%8F%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.1.</span> <span class="toc-text">度量聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E5%9D%87%E5%80%BC%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.2.</span> <span class="toc-text">平均值聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%A4%A7%E5%80%BC%E5%92%8C%E6%9C%80%E5%B0%8F%E5%80%BC%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.3.</span> <span class="toc-text">最大值和最小值聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%82%E5%92%8C%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.4.</span> <span class="toc-text">求和聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.5.</span> <span class="toc-text">统计聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%95%B0%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.6.</span> <span class="toc-text">基数聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BE%E5%88%86%E6%AF%94%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.7.</span> <span class="toc-text">百分比聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BE%E5%88%86%E6%AF%94%E7%AD%89%E7%BA%A7%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.8.</span> <span class="toc-text">百分比等级聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B4%E9%83%A8%E5%90%8D%E4%B8%AD%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.9.</span> <span class="toc-text">头部名中聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A9%E8%AF%81%E7%BB%9F%E8%AE%A1%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.10.</span> <span class="toc-text">矩证统计聚集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%B6%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.11.</span> <span class="toc-text">桶聚集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%8D%E6%9D%A1%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.11.1.</span> <span class="toc-text">词条聚集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.11.2.</span> <span class="toc-text">范围聚集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E6%9C%9F%E8%8C%83%E5%9B%B4%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.11.3.</span> <span class="toc-text">日期范围聚集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%96%B9%E5%9B%BE%E8%81%9A%E9%9B%86"><span class="toc-number">1.5.11.4.</span> <span class="toc-text">直方图聚集</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/yangxiao.github.io/2023/12/26/ElasticSearch/" title="ElasticSearch">ElasticSearch</a><time datetime="2023-12-25T16:03:26.971Z" title="发表于 2023-12-26 00:03:26">2023-12-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/yangxiao.github.io/2023/12/20/Mysql/" title="Mysql">Mysql</a><time datetime="2023-12-20T14:48:43.327Z" title="发表于 2023-12-20 22:48:43">2023-12-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/yangxiao.github.io/2023/12/20/kafka/" title="Kafka">Kafka</a><time datetime="2023-12-20T14:48:08.499Z" title="发表于 2023-12-20 22:48:08">2023-12-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/yangxiao.github.io/2023/12/19/test/" title="test">test</a><time datetime="2023-12-19T13:18:38.000Z" title="发表于 2023-12-19 21:18:38">2023-12-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/yangxiao.github.io/2023/12/18/hello-world/" title="Hello World">Hello World</a><time datetime="2023-12-18T14:51:37.606Z" title="发表于 2023-12-18 22:51:37">2023-12-18</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2023 By <a class="footer-bar-link" href="/yangxiao.github.io/" title="XIAO YANG" target="_blank">XIAO YANG</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/yangxiao.github.io/archives/" title="archive"><div class="headline">文章</div><div class="length-num">5</div></a><a href="/yangxiao.github.io/tags/" title="tag"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/yangxiao.github.io/categories/" title="category"><div class="headline">分类</div><div class="length-num">2</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/yangxiao.github.io/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/yangxiao.github.io/tags/Mysql/" style="font-size: 0.88rem;">Mysql<sup>1</sup></a><a href="/yangxiao.github.io/tags/test/" style="font-size: 0.88rem;">test<sup>1</sup></a><a href="/yangxiao.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 0.88rem;">中间件<sup>3</sup></a><a href="/yangxiao.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 0.88rem;">分布式<sup>1</sup></a><a href="/yangxiao.github.io/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/" style="font-size: 0.88rem;">搜索引擎<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/yangxiao.github.io/js/utils.js"></script><script src="/yangxiao.github.io/js/main.js"></script><script src="/yangxiao.github.io/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2020 By 安知鱼 V1.6.12",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 XIAO YANG 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/yangxiao.github.io/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>